/*!
 nehan.js
 Copyright (C) 2010 - 2015 Watanabe Masaki<lambda.watanabe[at]gmail.com>
 repository: https://github.com/tategakibunko/nehan.js

 licensed under MIT license.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/
var Nehan=Nehan||{};Nehan.version="5.0.6",Nehan.Client=function(){function t(){this.userAgent=navigator.userAgent.toLowerCase(),this.name=navigator.appName.toLowerCase(),this.version=parseInt(navigator.appVersion,10),this._parseUserAgent(this.userAgent)}return t.prototype={isWindows:function(){return this.userAgent.indexOf("windows")>=0},isMacintosh:function(){return this.userAgent.indexOf("macintosh")>=0},isIphone:function(){return this.userAgent.indexOf("iphone")>=0},isIpod:function(){return this.userAgent.indexOf("ipod")>=0},isIpad:function(){return this.userAgent.indexOf("ipad")>=0},isAppleMobileFamily:function(){return this.isIphone()||this.isIpod()||this.isIpad()},isAndroid:function(){return this.userAgent.indexOf("android")>=0},isSmartPhone:function(){return this.isAppleMobileFamily()||this.isAndroid()},isWebkit:function(){return this.userAgent.indexOf("webkit")>=0},isIE:function(){return"msie"===this.name},isTrident:function(){return this.isIE()&&this.version>=11},isChrome:function(){return"chrome"===this.name},isSafari:function(){return"safari"===this.name},_parseUserAgent:function(t){return t.indexOf("trident")>=0&&t.indexOf("msie")<0?(this.name="msie",void(this.version=this._parseVersionPureTrident(t))):t.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(?:\.\d+)*)/)?(this.name=RegExp.$1.toLowerCase(),void(this.version=this._parseVersionNormalClient(t,parseInt(RegExp.$2,10)))):this.isAppleMobileFamily()?(this.name="safari",void(this.version=this._parseVersionAppleMobileFamily(t))):void 0},_parseVersionPureTrident:function(t){return t.match(/rv:([\.\d]+)/)?parseInt(RegExp.$1,10):this.version},_parseVersionNormalClient:function(t,e){return t.match(/version\/([\.\d]+)/)?parseInt(RegExp.$1,10):e},_parseVersionAppleMobileFamily:function(t){return t.match(/os ([\d_]+) like/)?parseInt(RegExp.$1,10):this.version}},t}(),Nehan.Env=function(){var t=new Nehan.Client,e=!(t.isIE()&&t.version<=8),n=t.isChrome()&&t.version>=24,i=t.isSafari()&&t.version>=5,r=n||i;return{client:t,isTransformEnable:e,isVerticalGlyphEnable:r}}(),Nehan.engineId=0,Nehan.globalStyle={},Nehan.__single_tag_names__=[],Nehan.__single_tag_rexes__=[],Nehan.setStyle=function(t,e){var n=Nehan.globalStyle[t]||{};for(var i in e)n[i]=e[i];Nehan.globalStyle[t]=n},Nehan.setStyles=function(t){for(var e in t)Nehan.setStyle(e,t[e])},Nehan.addSingleTagByName=function(t){Nehan.__single_tag_names__.push(t)},Nehan.addSingleTagByRex=function(t){Nehan.__single_tag_rexes__.push(t)},Nehan.createEngine=Nehan.setup=function(t){"use strict";function e(){this.documentContext=Se,this.lexingRule=s,this.selectors=M}var n=t||{};Nehan.engineId++;var i={lang:"ja-JP",debug:!1,kerning:!0,justify:!0,maxRollbackCount:20,maxPageCount:1e4,useVerticalGlyphIfEnable:!0,useStrictWordMetrics:!0,enableAutoCloseTag:!1,disableInlineStyle:!1,lexingBufferLen:2e3},r={root:"document",direction:"vert",boxFlow:{hori:"lr-tb",vert:"tb-rl"},pagingDirection:{hori:"lr",vert:"rl"},width:screen.width,height:screen.height,fontSize:16,minFontSize:12,maxFontSize:90,minTableCellSize:48,rubyRate:.5,boldRate:.5,lineRate:2,vertWordSpaceRate:.25,fontColor:"000000",linkColor:"0000FF",fontImgRoot:"http://nehan.googlecode.com/hg/char-img",fontFamily:"'ヒラギノ明朝 Pro W3','Hiragino Mincho Pro','HiraMinProN-W3','IPA明朝','IPA Mincho', 'Meiryo','メイリオ','ＭＳ 明朝','MS Mincho', monospace",fontSizeNames:{"xx-large":"33px","x-large":"24px",large:"18px",medium:"16px",small:"13px","x-small":"10px","xx-small":"8px",larger:"1.2em",smaller:"0.8em"},getMeasure:function(t){return this[t.getPropMeasure()]},getExtent:function(t){return this[t.getPropExtent()]},getPagingDirection:function(){return this.pagingDirection[this.direction]},getStdBoxFlow:function(){var t=this.boxFlow[this.direction];return Q.getByName(t)},getStdVertFlow:function(){return Q.getByName(this.boxFlow.vert)},getStdHoriFlow:function(){return Q.getByName(this.boxFlow.hori)},getRtFontSize:function(t){var e=a.rt||null,n=e?e["font-size"]:null;return null===e||null===n?Math.round(this.rubyRate*t):$e.prototype._computeUnitSize.call(this,n,t)},getPaletteFontColor:function(t){return t.getValue().toLowerCase()!==this.fontColor.toLowerCase()?t.getPaletteValue():this.fontColor}},s=function(){var t=["br","hr","img","input","link","meta","wbr","?xml","!doctype","page-break","end-page","pbr"],e=[],n=function(e){return u.exists(t,m.eq(e))},i=function(t){return u.exists(e,function(e){return e.test(t)})},r=function(t){return u.exists(e,function(e){return t.source===e.source})};return{isSingleTag:function(t){return n(t)||i(t)||!1},addSingleTagByName:function(e){n(e)||t.push(e)},addSingleTagByRex:function(t){r(t)||e.push(t)}}}(),a={a:{display:"inline"},abbr:{display:"inline"},address:{display:"inline","font-style":"italic",section:!0},area:{},article:{display:"block",section:!0},aside:{display:"block",section:!0},audio:{},b:{display:"inline","font-weight":"bold"},base:{},bdi:{display:"inline"},bdo:{display:"inline"},blockquote:{color:"#666666",display:"block","section-root":!0,padding:{start:"1em",end:"1em",before:"0.5em",after:"0.5em"},margin:{after:"1.5em"}},body:{display:"block","section-root":!0},br:{display:"inline"},button:{display:"inline",interactive:!0},canvas:{display:"inline",embeddable:!0},caption:{display:"table-caption","text-align":"center",margin:{after:"0.5em"}},cite:{display:"inline"},code:{"font-family":"'andale mono', 'lucida console', monospace",display:"inline"},col:{display:"table-column"},colgroup:{display:"table-column-group"},command:{},datalist:{},dd:{display:"block",margin:{start:"1em",end:"1em",after:"1.6em"}},del:{color:"#666666",display:"inline"},details:{display:"block","section-root":!0},dfn:{display:"inline","font-style":"italic"},div:{display:"block"},dl:{display:"block"},dt:{display:"block","font-weight":"bold",margin:{after:"0.2em"}},em:{display:"inline","font-style":"italic"},embed:{},fieldset:{display:"block","section-root":!0,padding:{start:"1em",end:"0.2em",before:"0.2em",after:"1em"},margin:{after:"1.5em"},"border-width":"1px"},figure:{display:"block","section-root":!0},figcaption:{display:"block","text-align":"center","font-size":"0.8em"},footer:{display:"block",section:!0},font:{display:"inline"},form:{display:"block"},h1:{display:"block","font-size":"2.4em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"0.5em"}},h2:{display:"block","font-size":"2.0em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"0.75em"}},h3:{display:"block","font-size":"1.6em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1em"}},h4:{display:"block","font-size":"1.4em","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1.25em"}},h5:{display:"block","font-size":"1.0em","font-weight":"bold","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace",margin:{after:"1.5em"}},h6:{display:"block","font-weight":"bold","font-family":"'Meiryo','メイリオ','Hiragino Kaku Gothic Pro','ヒラギノ角ゴ Pro W3','Osaka','ＭＳ Ｐゴシック', monospace","font-size":"1.0em"},head:{display:"none"},header:{display:"block",section:!0},hr:{display:"block","box-sizing":"content-box","border-color":"#b8b8b8","border-style":"solid",margin:{after:"1em"},extent:"1px","border-width":{before:"1px"}},"hr.nehan-space":{"border-width":"0px"},html:{display:"block"},i:{display:"inline"},iframe:{display:"block",embeddable:!0},ins:{},img:{display:"inline","box-sizing":"content-box"},input:{display:"inline",interactive:!0},kbd:{display:"inline"},keygen:{},label:{display:"inline"},legend:{display:"block","font-weight":"bold","line-rate":1.5},li:{display:"list-item",margin:{after:"0.6em"}},"li-marker":{display:"block"},"li-body":{display:"block"},link:{meta:!0},main:{display:"block"},map:{},mark:{display:"inline"},menu:{display:"block"},meta:{meta:!0},meter:{display:"inline"},nav:{display:"block",section:!0},noscript:{meta:!0},object:{display:"inline",embeddable:!0},ol:{display:"block","list-style-image":"none","list-style-position":"outside","list-style-type":"decimal",margin:{before:"1em"}},"ol ol":{margin:{before:"0em"}},"ol ul":{margin:{before:"0em"}},optgroup:{},option:{},output:{},p:{display:"block",margin:{after:"1.5em"}},param:{},pre:{display:"block","white-space":"pre"},progress:{display:"inline"},q:{display:"block"},rb:{display:"inline"},rp:{display:"inline"},ruby:{display:"inline"},rt:{"font-size":"0.5em","line-rate":1,display:"inline"},s:{display:"inline"},samp:{display:"inline"},script:{display:"inline",meta:!0},section:{display:"block",section:!0},select:{},small:{display:"inline","font-size":"0.8em"},source:{},span:{display:"inline"},strong:{display:"inline","font-weight":"bold"},style:{display:"inline",meta:!0},sub:{display:"inine"},summary:{display:"inline"},sup:{display:"inine"},table:{display:"table",embeddable:!0,"table-layout":"fixed","background-color":"white","border-collapse":"collapse","border-color":"#a8a8a8","border-style":"solid","border-width":{start:"1px",before:"1px"},margin:{start:"0.5em",end:"0.5em",after:"1.6em"}},tbody:{display:"table-row-group","border-collapse":"inherit"},td:{display:"table-cell","section-root":!0,"border-width":{end:"1px"},"border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid",padding:{start:"0.5em",end:"0.5em",before:"0.4em",after:"0.4em"}},textarea:{display:"inline",embeddable:!0,interactive:!0},tfoot:{display:"table-footer-group","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid","font-style":"italic"},th:{display:"table-cell","line-rate":1.4,"border-width":{end:"1px"},"border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid",padding:{start:"0.5em",end:"0.5em",before:"0.4em",after:"0.4em"}},thead:{display:"table-header-group","font-weight":"bold","background-color":"#c3d9ff","border-color":"#a8a8a8","border-collapse":"inherit","border-style":"solid"},time:{display:"inline"},title:{meta:!0},tr:{display:"table-row","border-collapse":"inherit","border-color":"#a8a8a8","border-style":"solid","border-width":{after:"1px"}},track:{},u:{display:"inline"},ul:{display:"block","list-style-image":"none","list-style-type":"disc","list-style-position":"outside",margin:{before:"1em"}},"ul ul":{margin:{before:"0em"}},"ul ol":{margin:{before:"0em"}},"var":{display:"inline"},video:{display:"inline",embeddable:!0},wbr:{display:"inline"},"?xml":{},"!doctype":{},"first-line":{display:"block"},"page-break":{display:"inline"},pbr:{display:"inline"},"end-page":{display:"inline"},".nehan-rounded":{padding:{before:"1.6em",end:"1.0em",after:"1.6em",start:"1.0em"},"border-radius":"10px"},".nehan-xx-large":{"font-size":r.fontSizeNames["xx-large"]},".nehan-x-large":{"font-size":r.fontSizeNames["x-large"]},".nehan-large":{"font-size":r.fontSizeNames.large},".nehan-medium":{"font-size":r.fontSizeNames.medium},".nehan-small":{"font-size":r.fontSizeNames.small},".nehan-x-small":{"font-size":r.fontSizeNames["x-small"]},".nehan-xx-small":{"font-size":r.fontSizeNames["xx-small"]},".nehan-larger":{"font-size":r.fontSizeNames.larger},".nehan-smaller":{"font-size":r.fontSizeNames.smaller},".nehan-content-box":{"box-sizing":"content-box"},".nehan-border-box":{"box-sizing":"border-box"},".nehan-margin-box":{"box-sizing":"margin-box"},".nehan-disp-none":{display:"none"},".nehan-disp-block":{display:"block"},".nehan-disp-inline":{display:"inline"},".nehan-disp-iblock":{display:"inline-block"},".nehan-ta-start":{"text-align":"start"},".nehan-ta-center":{"text-align":"center"},".nehan-ta-end":{"text-align":"end"},".nehan-float-start":{"float":"start"},".nehan-float-end":{"float":"end"},".nehan-flow-lr-tb":{flow:"lr-tb"},".nehan-flow-tb-rl":{flow:"tb-rl"},".nehan-flow-tb-lr":{flow:"tb-lr"},".nehan-flow-rl-tb":{flow:"rl-tb"},".nehan-flow-flip":{flow:"flip"},".nehan-lsp-inside":{"list-style-position":"inside"},".nehan-lsp-outside":{"list-style-position":"outside"},".nehan-lst-none":{"list-style-type":"none"},".nehan-lst-decimal":{"list-style-type":"decimal"},".nehan-lst-disc":{"list-style-type":"disc"},".nehan-lst-circle":{"list-style-type":"circle"},".nehan-lst-square":{"list-style-type":"square"},".nehan-lst-decimal-leading-zero":{"list-style-type":"decimal-leading-zero"},".nehan-lst-lower-alpha":{"list-style-type":"lower-alpha"},".nehan-lst-upper-alpha":{"list-style-type":"upper-alpha"},".nehan-lst-lower-latin":{"list-style-type":"lower-latin"},".nehan-lst-upper-latin":{"list-style-type":"upper-latin"},".nehan-lst-lower-roman":{"list-style-type":"lower-roman"},".nehan-lst-upper-roman":{"list-style-type":"upper-roman"},".nehan-lst-lower-greek":{"list-style-type":"lower-greek"},".nehan-lst-upper-greek":{"list-style-type":"upper-greek"},".nehan-lst-cjk-ideographic":{"list-style-type":"cjk-ideographic"},".nehan-lst-hiragana":{"list-style-type":"hiragana"},".nehan-lst-hiragana-iroha":{"list-style-type":"hiragana-iroha"},".nehan-lst-katakana":{"list-style-type":"katakana"},".nehan-lst-katakana-iroha":{"list-style-type":"katakana-iroha"},".nehan-tcy":{"text-combine":"horizontal"},".nehan-text-combine":{"text-combine":"horizontal"},".nehan-empha-dot-filled":{"text-emphasis-style":"filled dot"},".nehan-empha-dot-open":{"text-emphasis-style":"open dot"},".nehan-empha-circle-filled":{"text-emphasis-style":"filled circle"},".nehan-empha-circle-open":{"text-emphasis-style":"open circle"},".nehan-empha-double-circle-filled":{"text-emphasis-style":"filled double-circle"},".nehan-empha-double-circle-open":{"text-emphasis-style":"open double-circle"},".nehan-empha-triangle-filled":{"text-emphasis-style":"filled triangle"},".nehan-empha-triangle-open":{"text-emphasis-style":"open triangle"},".nehan-empha-sesame-filled":{"text-emphasis-style":"filled sesame"},".nehan-empha-sesame-open":{"text-emphasis-style":"open sesame"},".nehan-break-before":{"break-before":"always"},".nehan-break-after":{"break-after":"always"},".nehan-wb-all":{"word-break":"break-all"},".nehan-wb-normal":{"word-break":"normal"},".nehan-wb-keep":{"word-break":"keep-all"},".nehan-drop-caps::first-letter":{display:"inline-block","box-sizing":"content-box",measure:"1em",extent:"1em","float":"start","line-rate":1,"font-size":"4em",onload:function(t){return t.isTextHorizontal()?{"line-height":"1em"}:{}}},".nehan-gap-start":{margin:{start:"1em"}},".nehan-gap-end":{margin:{end:"1em"}},".nehan-gap-after":{margin:{after:"1em"}},".nehan-gap-before":{margin:{before:"1em"}}},o={};o.extend=function(t,e){function n(){}n.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new n,t.prototype.constructor=t};var u={iter:function(t,e){for(var n=0,i=t.length;i>n;n++)e(t[n])},iteri:function(t,e){for(var n=0,i=t.length;i>n;n++)e(n,t[n])},reviter:function(t,e){for(var n=t.length-1;n>=0;n--)e(t[n])},reviteri:function(t,e){for(var n=t.length-1;n>=0;n--)e(n,t[n])},forall:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!e(t[n]))return!1;return!0},map:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n.push(e(t[i]));return n},mapi:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n.push(e(i,t[i]));return n},fold:function(t,e,n){for(var i=e,r=0,s=t.length;s>r;r++)i=n(i,t[r]);return i},filter:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)e(t[i])&&n.push(t[i]);return n},find:function(t,e){for(var n=0,i=t.length;i>n;n++){var r=t[n];if(e(r))return r}return null},revfind:function(t,e){for(var n=t.length-1;n>=0;n--){var i=t[n];if(e(i))return i}return null},indexOf:function(t,e){for(var n=0,i=t.length;i>n;n++){var r=t[n];if(e(r))return n}return-1},exists:function(t,e){for(var n=0,i=t.length;i>n;n++)if(e(t[n]))return!0;return!1},mem:function(t,e){for(var n=0,i=t.length;i>n;n++)if(t[n]==e)return!0;return!1},sum:function(t){return this.fold(t,0,function(t,e){return t+e})},minobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||i>r)&&(n=t,i=r)}),n},maxobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||r>i)&&(n=t,i=r)}),n},refcopy:function(t){for(var e=[],n=0,i=t.length;i>n;n++)e[n]=t[n];return e},count:function(t,e){for(var n=0,i=0,r=t.length;r>i;i++)e(t[i])&&n++;return n},create:function(t,e){var n=new Array(t);if("undefined"!=typeof e)for(var i=0;t>i;i++)n[i]=e;return n},first:function(t){return t[0]||null},last:function(t){var e=t.length;return 0===e?null:t[e-1]},zip:function(t,e){for(var n=[],i=0,r=Math.min(t.length,e.length);r>i;i++)n[i]=[t[i],e[i]];return n},zipObj:function(t,e){var n={};if(t.length!==e.length)throw"invalid args:List.zipObj";for(var i=0,r=t.length;r>i;i++)n[t[i]]=e[i];return n},reverse:function(t){var e=[];return this.reviter(t,function(t){e.push(t)}),e}},l={isEmpty:function(t){for(var e in t)return!1;return!0},map:function(t,e){var n={};return this.iter(t,function(t,i){n[t]=e(t,i)}),n},filter:function(t,e){var n={};return this.iter(t,function(t,i){e(t,i)&&(n[t]=i)}),n},iter:function(t,e){for(var n in t)e(n,t[n])}},h={trimHeadCRLF:function(t){return t.replace(/^\n+/,"")},trimFootCRLF:function(t){return t.replace(/\n+$/,"")},trimCRLF:function(t){return this.trimFootCRLF(this.trimHeadCRLF(t))},trim:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},cutQuote:function(t){return t.replace(/['\"]/g,"")},capitalize:function(t){return""===t?"":t.charAt(0).toUpperCase()+t.slice(1)},filenameConcat:function(t,e){return t=""===t?"":"/"===t.slice(-1)?t:t+"/",e=""===e?"":"/"===e[0]?e.substring(1,e.length):e,t+e},camelize:function(t){var e=this;return t.indexOf("-")<0?t:u.mapi(t.split("-"),function(t,n){return 0===t?n:e.capitalize(n)}).join("")}},c={convBase:function(t,e){if(0===t)return[0];for(var n=[],i=t;i>0;)n.unshift(i%e),i=Math.floor(i/e);return n}},f=function(){var t=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e,n){var i="undefined"==typeof n?t:n;window.setTimeout(e,i)}}(),g={cssVenderPrefixes:["-moz","-webkit","-o","-ms"],cssCorders:["top-left","top-right","bottom-left","bottom-right"],cssBorderRadius:["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"],cssBoxDirs:["top","right","bottom","left"],cssBoxDirsLogical:["before","end","after","start"],cssBoxCornersLogical:["start-before","end-before","end-after","start-after"],css2dIndex:{1:[0,0],2:[0,1]},css4dIndex:{1:[0,0,0,0],2:[0,1,0,1],3:[0,1,2,1],4:[0,1,2,3]},space:"&nbsp;",clearFix:"<div style='clear:both'></div>"},d={toString:function(t){var e=[];for(var n in t)e.push(n+":"+t[n]);return e.join(";")},addNehanPrefix:function(t){return"nehan-"+t},addNehanHeaderPrefix:function(t){return"nehan-header-"+t},addNehanTocLinkPrefix:function(t){return"nehan-toc-link-"+t},setCssValueWithVender:function(t,e,n){return t[e]=n,u.iter(g.cssVenderPrefixes,function(i){t[i+"-"+e]=n}),t}},p={escape:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},unescape:function(t){var e=document.createElement("div");return e.innerHTML=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\r/g,"&#13;").replace(/\n/g,"&#10;"),e.textContent||e.innerText},attr:function(t){var e=[];for(var n in t)"undefined"!=typeof t[n]&&""!==t[n]&&e.push(n+"='"+this.escape(t[n]+"")+"'");return e==[]?"":e.join(" ")},tagWrap:function(t,e,n){return[this.tagStart(t,n||{}),e,this.tagEnd(t)].join("")},tagSingle:function(t,e){return"<"+t+" "+this.attr(e)+"/>"},tagStart:function(t,e){return"<"+t+" "+this.attr(e)+">"},tagEnd:function(t){return"</"+t+">"}},m={id:function(){return function(t){return t}},eq:function(t){return function(e){return t==e}},neq:function(t){return function(e){return t!=e}}},y={copy:function(t,e){t=t||{};for(var n in e)t[n]=e[n];return t},copy2:function(t,e){t=t||{};for(var n in e)"object"==typeof t[n]?this.copy2(t[n],e[n]):t[n]=e[n];return t},merge:function(t,e,n){t=t||{};for(var i in e)t[i]="undefined"==typeof n[i]?e[i]:n[i];return t}},x=function(){function t(){this._values={}}return t.prototype={iter:function(t){l.iter(this._values,t)},filter:function(t){return l.filter(this._values,t)},merge:function(t,e){return e},union:function(t){var e=this;return t.iter(function(t,n){e.add(t,n)}),this},get:function(t){return this._values[t]||null},add:function(t,e){var n=this._values[t]||null;this._values[t]=n?this.merge(n,e):e},addValues:function(t){t=t||{};for(var e in t)this.add(e,t[e])},remove:function(t){delete this._values[t]}},t}(),b=function(){function t(){x.call(this)}return o.extend(t,x),t.prototype.merge=function(t,e){return"object"==typeof t?(y.copy(t,e),t):e},t.prototype.copyValuesTo=function(t){return y.copy(t,this._values)},t}(),v=function(){var t=function(t){return h.trim(String(t)).replace(/;/g,"").replace(/\n/g,"")},e=function(t){return t.indexOf(" ")<0?[t]:t.split(/\s+/)},n=function(t){return t.indexOf("/")<0?[t]:t.split("/")},i=function(t,e){var n={};if(t.length!==e.length)throw"invalid args:__zip_obj";return u.iteri(t,function(t,i){n[i]=e[t]}),n},r=function(t){return g.css2dIndex[Math.min(t,2)]||[]},s=function(t){return g.css4dIndex[Math.min(t,4)]||[]},a=function(t,e){return u.map(e,function(e){return t[e]})},o=function(t){var e=r(t.length);return a(t,e)},l=function(t){var e=s(t.length);return a(t,e)},c=function(t){var e=g.cssBoxDirsLogical,n=l(t);return u.zipObj(e,n)},f=function(t){var e=g.cssBoxCornersLogical,n=l(t);return i(e,n)},d=function(t){return c(e(t))},p=function(t){var i=o(n(t)),r=u.map(i,function(t){return l(e(t))}),s=u.zip(r[0],r[1]);return f(s)},m=function(t){return t.indexOf("margin-")>=0||t.indexOf("padding-")>=0||t.indexOf("border-width-")>=0?t.split("-")[0]:t},y=function(e,n){switch(typeof n){case"function":case"object":case"boolean":return n}switch(n=t(n),e){case"border-width":return d(n);case"border-radius":return p(n);case"border-color":return d(n);case"border-style":return d(n);case"margin":return d(n);case"padding":return d(n);case"margin-before":case"padding-before":case"border-width-before":return{before:n};case"margin-end":case"padding-end":case"border-width-end":return{end:n};case"margin-after":case"padding-after":case"border-width-after":return{after:n};case"margin-start":case"padding-start":case"border-width-start":return{start:n};default:return n}};return{formatProp:function(t){return m(t)},formatValue:function(t,e){return y(t,e)}}}(),_=function(){function t(t){this.expr=this._normalize(t),this.left=this.op=this.right=null,this._parseExpr(this.expr)}var e=/[^=^~|$*\s]+/,n=["|=","~=","^=","$=","*=","="];return t.prototype={_normalize:function(t){return t.replace(/\[/g,"").replace(/\]/g,"")},_parseSymbol:function(t){var n=t.match(e);return n?n[0]:""},_parseOp:function(t){return u.find(n,function(e){return t.indexOf(e)>=0})},_parseExpr:function(t){this.left=this._parseSymbol(t),this.left&&(t=h.trim(t.slice(this.left.length))),this.op=this._parseOp(t),this.op&&(t=h.trim(t.slice(this.op.length)),this.right=h.cutQuote(h.trim(t)))},_testHasAttr:function(t){return null!==t.getMarkupAttr(this.left)},_testEqual:function(t){var e=t.getMarkupAttr(this.left);return e===this.right},_testCaretEqual:function(t){var e=t.getMarkupAttr(this.left),n=new RegExp("^"+this.right);return n.test(e)},_testDollarEqual:function(t){var e=t.getMarkupAttr(this.left),n=new RegExp(this.right+"$");return n.test(e)},_testTildeEqual:function(t){var e=t.getMarkupAttr(this.left),n=e?e.split(/\s+/):[];return u.exists(n,m.eq(this.right))},_testPipeEqual:function(t){var e=t.getMarkupAttr(this.left);return e?e==this.right||e.indexOf(this.right+"-")>=0:!1},_testStarEqual:function(t){var e=t.getMarkupAttr(this.left);return e.indexOf(this.right)>=0},_testOp:function(t){switch(this.op){case"=":return this._testEqual(t);case"^=":return this._testCaretEqual(t);case"$=":return this._testDollarEqual(t);case"|=":return this._testPipeEqual(t);case"~=":return this._testTildeEqual(t);case"*=":return this._testStarEqual(t)}throw"undefined operation:"+this.op},test:function(t){return this.op&&this.left&&this.right?this._testOp(t):this.left?this._testHasAttr(t):!1}},t}(),k=function(){function t(t){this.name=this._normalize(t)}return t.prototype={hasPseudoElement:function(){return"before"===this.name||"after"===this.name||"first-letter"===this.name||"first-line"===this.name},test:function(t){switch(this.name){case"before":return!0;case"after":return!0;case"first-letter":return!t.isMarkupEmpty();case"first-line":return!t.isMarkupEmpty();case"first-child":return t.isFirstChild();case"last-child":return t.isLastChild();case"first-of-type":return t.isFirstOfType();case"last-of-type":return t.isLastOfType();case"only-child":return t.isOnlyChild();case"only-of-type":return t.isOnlyOfType();case"empty":return t.isMarkupEmpty();case"root":return t.isRoot()}return!1},_normalize:function(t){return t.replace(/:+/g,"")}},t}(),C=function(){function t(t){this.name=t.name||null,this.nameRex=t.nameRex||null,this.id=t.id||null,this.classes=t.classes||[],this.attrs=t.attrs||[],this.pseudo=t.pseudo||null}return t.prototype={test:function(t){return null===t?!1:this.name&&!this.testName(t.getMarkupName())?!1:this.nameRex&&!this.testNameRex(t.getMarkupName())?!1:this.classes.length>0&&!this.testClassNames(t.getMarkupClasses())?!1:this.id&&t.getMarkupId()!=this.id?!1:this.attrs.length>0&&!this._testAttrs(t)?!1:this.pseudo&&!this.pseudo.test(t)?!1:!0},testName:function(t){return null===this.name?!1:"*"===this.name?!0:t===this.name},testNameRex:function(t){return null===this.nameRex?!1:this.nameRex.test(t)},testClassNames:function(t){return u.forall(this.classes,function(e){return u.exists(t,m.eq(e))})},getNameSpec:function(){return this.nameRex?1:null===this.name||"*"===this.name?0:1},getIdSpec:function(){return this.id?1:0},getClassSpec:function(){return this.classes.length},getAttrSpec:function(){return this.attrs.length},getPseudoClassSpec:function(){return this.pseudo?this.pseudo.hasPseudoElement()?0:1:0},_testAttrs:function(t){return u.forall(this.attrs,function(e){return e.test(t)})}},t}(),w=function(){function t(t){this.buff=this._normalize(t)}var e=/^[\w-_\*!\?]+/,n=/^\/[^\/]+\//,i=/^#[\w-_]+/,r=/^\.[\w-_]+/,s=/^\[[^\]]+\]/,a=/^:{1,2}[\w-_]+/;return t.prototype={getTokens:function(){for(var t=[];""!==this.buff;){var e=this._getNextToken();if(null===e)break;t.push(e)}return t},_getNextToken:function(){if(this.buff=h.trim(this.buff),""===this.buff)return null;var t=this.buff.charAt(0);switch(t){case"+":case"~":case">":return this._stepBuff(1),t;default:return this._getTypeSelector()}throw"invalid selector:["+this.buff+"]"},_normalize:function(t){return h.trim(t).replace(/\s+/g," ")},_stepBuff:function(t){this.buff=h.trim(this.buff.slice(t))},_getByRex:function(t){var e=null,n=this.buff.match(t);return n&&(e=n[0],this._stepBuff(e.length)),e},_getTypeSelector:function(){var t=this.buff.length,e=this._getName(),n=null===e?this._getNameRex():null,i=this._getId(),r=this._getClasses(),s=this._getAttrs(),a=this._getPseudo();if(this.buff.length===t)throw"invalid selector:["+this.buff+"]";return new C({name:e,nameRex:n,id:i,classes:r,attrs:s,pseudo:a})},_getName:function(){return this._getByRex(e)},_getNameRex:function(){var t=this._getByRex(n);return null===t?null:new RegExp(t.replace(/[\/]/g,""))},_getId:function(){var t=this._getByRex(i);return t?t.substring(1):null},_getClasses:function(){for(var t=[];;){var e=this._getClass();if(null===e)break;t.push(e)}return t},_getClass:function(){var t=this._getByRex(r);return t?t.substring(1):null},_getAttrs:function(){for(var t=[];;){var e=this._getByRex(s);if(null===e)break;t.push(new _(e))}return t},_getPseudo:function(){var t=this._getByRex(a);return t?new k(t):null}},t}(),S=function(){var t=function(t,e){for(var n=t.parent;null!==n;){if(e.test(n))return n;n=n.parent}return null},e=function(t,e){var n=t.parent;return null===n?null:e.test(n)?n:null},n=function(t,e){var n=t.getChildIndex(),i=t.getParentNthChild(n-1)||null;return i&&e.test(i)?i:null},i=function(t,e){for(var n=t.getChildIndex(),i=0;n>i;i++){var r=t.getParentNthChild(i);if(r&&e.test(r))return r}return null};return{accept:function(r,s){if(0===s.length)throw"selector syntax error:"+src;for(var a,o,u,l,h=s.length-1,c=function(){return 0>h?null:s[h--]},f=function(){h++};h>=0;){if(a=c(),a instanceof C==!1)throw"selector syntax error:"+src;if(!a.test(r))return!1;if(o=c(),null===o)return!0;if(o instanceof C)u=o,l=" ";else if("string"==typeof o&&(l=o,u=c(),null===u||u instanceof C==!1))throw"selector syntax error:"+src;switch(l){case" ":r=t(r,u);break;case">":r=e(r,u);break;case"+":r=n(r,u);break;case"~":r=i(r,u);break;default:throw"selector syntax error:invalid combinator("+l+")"}if(null===r)return!1;f()}return!0}}}(),E=function(){function t(t,e){this.key=this._normalizeKey(t),this.value=this._formatValue(e),this.elements=this._getSelectorElements(this.key),this.spec=this._countSpec(this.elements)}return t.prototype={test:function(t){return S.accept(t,this.elements)},testPseudoElement:function(t,e){return this.hasPseudoElementName(e)&&this.test(t)},updateValue:function(t){for(var e in t){var n=v.formatValue(e,t[e]),i=v.formatProp(e),r=this.value[i]||null;null!==r&&"object"==typeof r&&"object"==typeof n?y.copy(r,n):this.value[i]=n}},getKey:function(){return this.key},getValue:function(){return this.value},getSpec:function(){return this.spec},hasPseudoElement:function(){return this.key.indexOf("::")>=0},hasPseudoElementName:function(t){return this.key.indexOf("::"+t)>=0},_countSpec:function(t){var e=0,n=0,i=0;return u.iter(t,function(t){t instanceof C&&(e+=t.getIdSpec(),n+=t.getClassSpec()+t.getPseudoClassSpec()+t.getAttrSpec(),i+=t.getNameSpec())}),parseInt([e,n,i].join(""),10)},_getSelectorElements:function(t){var e=new w(t);return e.getTokens()},_normalizeKey:function(t){return t=t instanceof RegExp?"/"+t.source+"/":t,h.trim(t).toLowerCase().replace(/\s+/g," ")},_formatValue:function(t){var e={};for(var n in t){var i=v.formatProp(n),r=v.formatValue(n,t[n]);e[i]=r}return e}},t}(),M=function(){var t=[],e=[],n=function(){t.sort(function(t,e){return t.spec-e.spec})},i=function(){e.sort(function(t,e){return t.spec-e.spec})},r=function(t){return t.indexOf("::")>=0},s=function(n){var i=r(n)?e:t;return u.find(i,function(t){return t.getKey()===n})},o=function(t,e){var n=a[t];y.copy(n,e);var i=s(t);i.updateValue(n)},h=function(n,i){var r=new E(n,i);return r.hasPseudoElement()?e.push(r):t.push(r),r},c=function(e){return u.fold(t,{},function(t,n){return n.test(e)?y.copy(t,n.getValue()):t})},f=function(t,n){return u.fold(e,{},function(e,i){return i.testPseudoElement(t,n)?y.copy(e,i.getValue()):e})},g=function(t,e){if(a[t])return void o(t,e);h(t,e);var r=h(t,e);a[t]=r.getValue(),r.hasPseudoElement()?i():n()},d=function(){l.iter(a,function(t,e){h(t,e)}),n(),i()};return d(),{setValue:function(t,e){g(t,e)},setValues:function(t){for(var e in t)g(e,t[e])},getValue:function(t){return c(t)},getValuePe:function(t,e){return f(t,e)}}}(),N=function(){function t(t){this.buff=t,this._error=!1}var e=/[^=\s]+/;return t.prototype={isEnd:function(){return this._error||""===this.buff},get:function(){var t=this._peek();if(null===t)return null;switch(t){case"=":return this._step(1),t;case"'":case'"':return this._getLiteral(t);case" ":return this._step(1),this.get();default:return this._getSymbol()}},_peek:function(){return this.buff?this.buff.charAt(0):null},_step:function(t){this.buff=this.buff.substring(t)},_getSymbol:function(){var t=ye.prototype._getByRex.call(this,e);return t&&this._step(t.length),t},_getLiteral:function(t){var e=this.buff.indexOf(t,1);if(0>e)return console.error("TagAttrLexer::syntax error:literal not closed(%s)",this.buff),this._error=!0,null;var n=this.buff.substring(1,e);return this._step(e+1),n}},t}(),A=function(){function t(t){this._lexer=new N(t),this._attrs={},this._left=null}return t.prototype={parse:function(){for(;!this._isEnd();)this._parseAttr();
return this._attrs},_isEnd:function(){return null===this._left&&this._lexer.isEnd()},_parseAttr:function(){var t=this._lexer.get();if(null===t)this._left&&(this._attrs[this._left]="true",this._left=null);else{if("="===t){if(null===this._left)throw"TagAttrParser::syntax error(=)";return this._attrs[this._left]=this._lexer.get()||"true",void(this._left=null)}this._left?(this._attrs[this._left]="true",this._left=t):this._left=t}}},t}(),T=function(){function t(t){var e=t?new A(t).parse():{};this.classes=this._parseClasses(e),this.attrs=this._parseAttrs(e,this.classes),this.dataset=this._parseDataset(e)}var e=function(t){return h.camelize(t.slice(5))};return t.prototype={hasAttr:function(){return"undefined"!=typeof this.attrs.name},hasClass:function(t){return u.exists(this.classes,m.eq(t))},addClass:function(t){return t=t.indexOf("nehan-")<0?"nehan-"+t:t,this.hasClass(t)||(this.classes.push(t),this.setAttr("class",[this.getAttr("class"),t].join(" "))),this.classes},removeClass:function(t){return this.classes=u.filter(this.classes,function(e){return e!=t}),this.setAttr("class",this.classes.join(" ")),this.classes},getAttr:function(t,e){return e="undefined"==typeof e?null:e,"undefined"==typeof this.attrs[t]?e:this.attrs[t]},getData:function(t,e){return e="undefined"==typeof e?null:e,"undefined"==typeof this.dataset[t]?e:this.dataset[t]},getClassesRaw:function(){return u.map(this.classes,function(t){return t.replace("nehan-","")})},setAttr:function(t,n){0===t.indexOf("data-")?this.setData(e(t),n):this.attrs[t]=n},setData:function(t,e){this.dataset[t]=e},_parseClasses:function(t){var e=t["class"]||"";e=h.trim(e.replace(/\s+/g," "));var n=""===e?[]:e.split(/\s+/);return u.map(n,function(t){return t.indexOf("nehan-")<0?"nehan-"+t:t})},_parseAttrs:function(t,e){var n={};return l.iter(t,function(t,i){"id"===t?n[t]=0===i.indexOf("nehan-")?i:"nehan-"+i:"class"===t?n[t]=e.join(" "):t.indexOf("data-")<0&&(n[t]=i)}),n},_parseDatasetValue:function(t){switch(t){case"true":return!0;case"false":return!1;default:return isNaN(t)?t:Number(t)}},_parseDataset:function(t){var n={};for(var i in t)0===i.indexOf("data-")&&(n[e(i)]=this._parseDatasetValue(t[i]));return n}},t}(),B=function(){function t(t,e){this._type="tag",this.src=t,this.content=e||"",this.name=this._parseName(this.src),this.attrs=this._parseTagAttrs(this.name,this.src)}return t.prototype={clone:function(){return new t(this.src,this.content)},setContent:function(t){this._fixed||(this.content=t)},setContentImmutable:function(t){this._fixed=t},setAlias:function(t){this.alias=t},setAttr:function(t,e){this.attrs.setAttr(t,e)},setAttrs:function(t){for(var e in t)this.setAttr(e,t[e])},setData:function(t,e){this.attrs.setData(t,e)},addClass:function(t){this.attrs.addClass(t)},removeClass:function(t){this.attrs.removeClass(t)},getId:function(){return this.attrs.id},getClasses:function(){return this.attrs.classes},getClassesRaw:function(){return this.attrs.getClassesRaw()},getName:function(){return this.alias||this.name},getAttr:function(t,e){return this.attrs.getAttr(t,e)},getData:function(t,e){return this.attrs.getData(t,e)},getContent:function(){return this.content},getSrc:function(){return this.src},getWrapSrc:function(){return""===this.content?this.src:this.src+this.content+"</"+this.name+">"},hasClass:function(t){return this.attrs.hasClass(t)},hasAttr:function(t){return this.attrs.hasAttr(t)},isHeaderTag:function(){return u.exists(["h1","h2","h3","h4","h5","h6"],m.eq(this.name))},isAnchorTag:function(){return"a"===this.name&&null!==this.getTagAttr("name")},isAnchorLinkTag:function(){var t=this.getTagAttr("href");return"a"===this.name&&t&&t.indexOf("#")>=0},isPageBreakTag:function(){return"page-break"===this.name||"end-page"===this.name||"pbr"===this.name},isCloseTag:function(){return"/"===this.name.charAt(0)},isSingleTag:function(){return this._single||!1},isEmpty:function(){return""===this.content},_getTagAttrSrc:function(t){return t.replace(/<[\S]+/,"").replace(/^\s+/,"").replace("/>","").replace(">","").replace(/\s+$/,"").replace(/\n/g," ").replace(/[　|\s]+/g," ").replace(/\s+=/g,"=").replace(/=\s+/g,"=")},_parseName:function(t){return t.replace(/</g,"").replace(/\/?>/g,"").split(/\s/)[0].toLowerCase()},_parseTagAttrs:function(t,e){var n=this._getTagAttrSrc(e);return new T(t.length===n.length?"":n)}},t}(),I={isTag:function(t){return"tag"===t._type},isText:function(t){return"char"===t._type||"word"===t._type||"tcy"===t._type||"ruby"===t._type},isChar:function(t){return"char"===t._type},isWord:function(t){return"word"===t._type},isTcy:function(t){return"tcy"===t._type},isEmphaTargetable:function(t){return"char"===t._type||"tcy"===t._type},isNewLine:function(t){return t instanceof z&&t.isNewLineChar()},isWhiteSpace:function(t){return t instanceof z&&t.isWhiteSpaceChar()}},z=function(){function t(t,e){this.data=t,this._type="char",this.isRef=e||!1,this.isRef?this._setupRef(t):this._setupNormal(t.charCodeAt(0))}var e=["。","."],n=["、",","],s=["｢","「","『","【","［","（","《","〈","≪","＜","｛","{","[","(","❲","〔"],a=["」","｣","』","】","］","）","》","〉","≫","＞","｝","}","]",")","❳","〕"],o=["ぁ","ぃ","ぅ","ぇ","ぉ","っ","ゃ","ゅ","ょ","ゎ","ァ","ィ","ゥ","ェ","ォ","ヵ","ヶ","ッ","ャ","ュ","ョ","ヮ"],l=["）","\\",")","」","】","〕","］","\\","]","。","』","＞","〉","》","、","．","\\",".",",","”","〟"],h=["（","\\","(","「","【","［","〔","\\","[","『","＜","〈","《","“","〝"];return t.prototype={getData:function(){return this.cnv||this.data},getCssPadding:function(t){var e=new ae;return this.paddingStart&&e.setStart(t.style.flow,this.paddingStart),this.paddingEnd&&e.setEnd(t.style.flow,this.paddingEnd),e.getCss()},getCssVertGlyph:function(){var t={},e=this.isPaddingEnable();return t["margin-left"]="auto",t["margin-right"]="auto",this.isKakkoStart()?"("===this.data?t.height="0.5em":e||(t["margin-top"]="-0.5em"):(this.getVertScale()<1&&(t.height="0.5em"),e&&(t["margin-bottom"]="0.5em")),t},getCssVertImgChar:function(t){var e={},n=t.style.getFontSize();return e.display="block",e.width=n+"px",e.height=this.getVertHeight(n)+"px",e["margin-left"]="auto",e["margin-right"]="auto",this.isPaddingEnable()&&y.copy(e,this.getCssPadding(t)),e},getCssVertRotateCharIE:function(t){var e={},n=t.style.getFontSize();return e["css-float"]="left",e["writing-mode"]="tb-rl",e["padding-left"]=Math.round(n/2)+"px",e["line-height"]=n+"px",e},getCssVertEmphaTarget:function(){var t={};return t},getCssVertEmphaText:function(t){var e={},n=t.style.getFontSize();return e.display="inline-block",e.width=n+"px",e.height=n+"px",e},getCssHoriEmphaTarget:function(){var t={};return t},getCssHoriEmphaText:function(){var t={};return t["line-height"]="1em",t},getCssVertLetterSpacing:function(t){var e={};return e["margin-bottom"]=t.letterSpacing+"px",e},getCssVertHalfSpaceChar:function(t){var e={},n=t.style.getFontSize(),i=Math.round(n/2);return e.height=i+"px",e["line-height"]=i+"px",e},getCssVertSmallKana:function(){var t={};return t.position="relative",t.top="-0.1em",t.right="-0.12em",t.height=this.bodySize+"px",t["line-height"]=this.bodySize+"px",t.clear="both",t},getHoriScale:function(){return this.hscale?this.hscale:1},getVertScale:function(){return this.vscale?this.vscale:1},getVertHeight:function(t){var e=this.getVertScale();return 1===e?t:Math.round(t*e)},hasMetrics:function(){return"undefined"!=typeof this.bodySize},getAdvance:function(t,e){return this.bodySize+this.getPaddingSize()+(e||0)},getPaddingSize:function(){return(this.paddingStart||0)+(this.paddingEnd||0)},getCharCount:function(){return" "===this.data||"	"===this.data||"　"===this.data?0:1},setMetrics:function(t,e){var n=t.isTextVertical(),i=n?this.getVertScale():this.getHoriScale();this.bodySize=1!=i?Math.round(e.size*i):e.size,this.spaceRateStart&&(this.paddingStart=Math.round(this.spaceRateStart*e.size)),this.spaceRateEnd&&(this.paddingEnd=Math.round(this.spaceRateEnd*e.size)),this.img&&"tenten"===this.img&&(this.bodySize=e.size),n||this.isRef||!this.isHankaku()||(this.bodySize=Math.round(e.size/2))},_setImg:function(t,e,n){this.img=t,this.vscale=e||1,this.hscale=n||this.vscale},_setCnv:function(t,e,n){this.cnv=t,this.vscale=e||1,this.hscale=n||this.vscale},_setRotate:function(t){this.rotate=t},_setRotateOrImg:function(t,e,n){return Nehan.Env.isTransformEnable?void this._setRotate(t):void this._setImg(e,n)},_setupRef:function(t){switch(t){case"&lt;":this._setRotateOrImg(90,"kakko7",.5);break;case"&gt;":this._setRotateOrImg(90,"kakko8",.5)}},_setupNormal:function(t){switch(t){case 32:this._setCnv("&nbsp;",.5,.5);break;case 12300:this._setImg("kakko1",.5);break;case 65378:this._setImg("kakko1",.5);break;case 12301:this._setImg("kakko2",.5);break;case 65379:this._setImg("kakko2",.5);break;case 12302:this._setImg("kakko3",.5);break;case 12303:this._setImg("kakko4",.5);break;case 65288:this._setImg("kakko5",.5);break;case 40:this._setImg("kakko5",.5);break;case 65371:this._setImg("kakko5",.5);break;case 123:this._setImg("kakko5",.5);break;case 65289:this._setImg("kakko6",.5);break;case 41:this._setImg("kakko6",.5);break;case 65373:this._setImg("kakko6",.5);break;case 125:this._setImg("kakko6",.5);break;case 65308:this._setImg("kakko7",.5);break;case 12296:this._setImg("kakko7",.5);break;case 65310:this._setImg("kakko8",.5);break;case 12297:this._setImg("kakko8",.5);break;case 12298:this._setImg("kakko9",.5);break;case 8810:this._setImg("kakko9",.5);break;case 12299:this._setImg("kakko10",.5);break;case 8811:this._setImg("kakko10",.5);break;case 65339:this._setImg("kakko11",.5);break;case 12308:this._setImg("kakko11",.5);break;case 91:this._setImg("kakko11",.5);break;case 65341:this._setImg("kakko12",.5);break;case 12309:this._setImg("kakko12",.5);break;case 93:this._setImg("kakko12",.5);break;case 12304:this._setImg("kakko17",.5);break;case 12305:this._setImg("kakko18",.5);break;case 65306:this._setImg("tenten",1,1);break;case 58:this._setImg("tenten",1,1);break;case 12290:this._setImg("kuten",.5);break;case 65377:this._setImg("kuten",.5);break;case 65294:this._setImg("period",1);break;case 46:this._setImg("period",1);break;case 12289:this._setImg("touten",.5);break;case 65380:this._setImg("touten",.5);break;case 44:this._setImg("touten",.5);break;case 65292:this._setImg("touten",.5);break;case 65374:this._setImg("kara",1);break;case 12316:this._setImg("kara",1);break;case 8230:this._setImg("mmm",1);break;case 8229:this._setImg("mm",1);break;case 12317:this._setImg("dmn1",1);break;case 12319:this._setImg("dmn2",1);break;case 65309:this._setImg("equal",1);break;case 61:this._setImg("equal",1);break;case 8212:this._setRotate(90);break;case 12540:this._setImg("onbiki",1);break;case 45:this._setCnv("&#65372;");break;case 8213:case 65293:case 9472:this._setCnv("&#8212;"),this._setRotate(90);break;case 8593:this._setCnv("&#8594;");break;case 8594:this._setCnv("&#8595;");break;case 8658:this._setCnv("&#8595;");break;case 8595:this._setCnv("&#8592;");break;case 8592:this._setCnv("&#8593;");break;case 8220:case 8221:case 8786:this._setRotate(90)}},isNewLineChar:function(){return"\n"===this.data},isSpaceChar:function(){return" "===this.data||"&nbsp;"===this.data||"	"===this.data},isWhiteSpaceChar:function(){return this.isNewLineChar()||this.isSpaceChar()},isImgChar:function(){return"undefined"!=typeof this.img},isCnvChar:function(){return"undefined"!=typeof this.cnv},isRotateChar:function(){return"undefined"!=typeof this.rotate},isCharRef:function(){return this.isRef},isHalfSpaceChar:function(){return this.isCnvChar()&&"&nbsp;"===this.cnv},isKerningChar:function(){return this.isKutenTouten()||this.isKakko()},getImgSrc:function(t){return[r.fontImgRoot,this.img,t+".png"].join("/")},isPaddingEnable:function(){return"undefined"!=typeof this.paddingStart||"undefined"!=typeof this.paddingEnd},isVertGlyphEnable:function(){return i.useVerticalGlyphIfEnable&&Nehan.Env.isVerticalGlyphEnable},isTenten:function(){return this.img&&"tenten"===this.img},isHeadNg:function(){return u.mem(l,this.data)},isTailNg:function(){return u.mem(h,this.data)},isSmallKana:function(){return u.mem(o,this.data)},isKakkoStart:function(){return u.mem(s,this.data)},isKakkoEnd:function(){return u.mem(a,this.data)},isKakko:function(){return this.isKakkoStart()||this.isKakkoEnd()},isKuten:function(){return u.mem(e,this.data)},isTouten:function(){return u.mem(n,this.data)},isKutenTouten:function(){return this.isKuten()||this.isTouten()},isZenkaku:function(){return"u"===escape(this.data).charAt(1)},isHankaku:function(){return!this.isZenkaku(this.data)}},t}(),P=function(){function t(t,e){this.data=t,this._type="word",this._divided=e||!1}return t.prototype={getData:function(){return this.data},getCssVertTrans:function(t){var e={};return t.style.letterSpacing&&(e["letter-spacing"]=t.style.letterSpacing+"px"),e.width=t.style.getFontSize()+"px",e.height=this.bodySize+"px",e["margin-left"]="auto",e["margin-right"]="auto",e["font-family"]="monospace",e},getCssVertTransBody:function(){var t={};return t["font-family"]="monospace",t},getCssVertTransBodyTrident:function(t){var e={};e["font-family"]="monospace",e.width=t.style.getFontSize()+"px",e.height=this.bodySize+"px",e["transform-origin"]="50% 50%",e["line-height"]=this.bodySize+"px";var n=Math.floor((this.bodySize-t.style.getFontSize())/2);return n>0&&(e.transform="rotate(90deg) translate(-"+n+"px, 0)"),e},getCssVertTransIE:function(t){var e={},n=t.style.getFontSize();return e["font-family"]="monospace",e["css-float"]="left",e["writing-mode"]="tb-rl",e["letter-spacing"]=(t.style.letterSpacing||0)+"px",e["padding-left"]=Math.round(n/2)+"px",e["line-height"]=n+"px",e},getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+(e||0)*this.getLetterCount()},hasMetrics:function(){return"undefined"!=typeof this.bodySize},countUpper:function(){for(var t=0,e=0;e<this.data.length;e++)/[A-Z]/.test(this.data.charAt(e))&&t++;return t},setMetrics:function(t,e){return i.useStrictWordMetrics&&W.isEnable()?void(this.bodySize=W.getMeasure(e,this.data)):(this.bodySize=Math.round(this.data.length*e.size*.5),void(e.isBold()&&(this.bodySize+=Math.round(r.boldRate*this.bodySize))))},getLetterCount:function(){return this.data.length},setDivided:function(t){this._divided=t},isDivided:function(){return this._divided},cutMeasure:function(e,n){var i=Math.round(e/2),r=Math.round(this.bodySize/i),s=Math.round(n/i);if(s>r)return this;var a=this.data.substring(0,s),o=new t(a,!0);return this.data=this.data.slice(s),this.setDivided(!0),o}},t}(),L=function(){function t(t){this.data=t,this._type="tcy"}return t.prototype={getData:function(){return this.data},getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+e},hasMetrics:function(){return"undefined"!=typeof this.bodySize},setMetrics:function(t,e){this.bodySize=e.size}},t}(),R=function(){function t(t,e){this._type="ruby",this.rbs=t,this.rt=e}return t.prototype={hasMetrics:function(){return"undefined"!=typeof this.advanceSize},getCharCount:function(){return this.rbs?this.rbs.length:0},getAdvance:function(){return this.advanceSize},getRbs:function(){return this.rbs},getRtString:function(){return this.rt?this.rt.getContent():""},getRtFontSize:function(){return this.rtFontSize},getCssHoriRuby:function(){var t={};return t.display="inline-block",t},getCssVertRt:function(){var t={};return t["css-float"]="left",t},getCssHoriRt:function(t){{var e={};Math.floor((t.style.getFontSize()-this.getRtFontSize())/3)}return e["font-size"]=this.getRtFontSize()+"px",e["line-height"]="1em",e},getCssVertRb:function(){var t={};return t["css-float"]="left",this.padding&&y.copy(t,this.padding.getCss()),t},getCssHoriRb:function(){var t={};return this.padding&&y.copy(t,this.padding.getCss()),t["text-align"]="center",t["line-height"]="1em",t},setMetrics:function(t,e,n){this.rtFontSize=r.getRtFontSize(e.size);var i=u.fold(this.rbs,0,function(i,r){return r.setMetrics(t,e),i+r.getAdvance(t,n)}),s=this.rtFontSize*this.getRtString().length;if(this.advanceSize=i,s>i){var a=Math.ceil((s-i)/2);this.rbs.length>0&&(this.padding=new ae,this.padding.setStart(t,a),this.padding.setEnd(t,a)),this.advanceSize+=a+a}}},t}(),F=function(){function t(t){this.value=String(t),this.red=parseInt(this.value.substring(0,2),16),this.green=parseInt(this.value.substring(2,4),16),this.blue=parseInt(this.value.substring(4,6),16)}return t.prototype={getRed:function(){return this.red},getGreen:function(){return this.green},getBlue:function(){return this.blue},getColorValue:function(){return this.value}},t}(),V=function(){function t(t){this.setValue(t)}return t.prototype={setValue:function(t){this.value=H.get(t)},getValue:function(){return this.value},getCssValue:function(){return"transparent"===this.value?this.value:"#"+this.value},getRgb:function(){return new F(this.value)},getCss:function(){var t={};return t.color=this.getCssValue(),t}},t}(),H=function(){var t={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4","indianred ":"cd5c5c","indigo ":"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32",transparent:"transparent"},e=/^(?:[0-9a-f]{3}){1,2}$/;return{get:function(n){return n=n.replace(/#/g,"").toLowerCase(),e.test(n)?3===n.length?n[0]+n[0]+n[1]+n[1]+n[2]+n[2]:n:t[n]||n}}}(),O=function(){var t=[0,36,73,109,146,182,219,255],e=[0,85,170,255],n=function(t){var e=t.toString(16);return e.length<=1?"0"+e:e},i=function(t,e){return u.exists(e,m.eq(t))?t:u.minobj(e,function(e){return Math.abs(e-t)})};return{getColor:function(r){var s=i(r.getRed(),t),a=i(r.getGreen(),t),o=i(r.getBlue(),e);return[n(s),n(a),n(o)].join("")}}}(),D=function(){var t={"lower-alpha":["a","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],"upper-alpha":["A","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],"lower-roman":["i","i","ii","iii","iv","v","vi","vii","viii","ix","x","xi","xii","xiii","xiv","xv","xvi","xvii","xviii","xix","xx"],"upper-roman":["I","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX"],"lower-greek":["α","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω"],"upper-greek":["Α","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],"cjk-ideographic":["〇","一","二","三","四","五","六","七","八","九","十"],hiragana:["あ","あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ","そ","た","ち","つ","て","と","な","に","ぬ","ね","の","は","ひ","ふ","へ","ほ","ま","み","む","め","も","や","ゆ","よ","ら","り","る","れ","ろ","わ","ゐ","ゑ","を","ん"],"hiragana-iroha":["い","い","ろ","は","に","ほ","へ","と","ち","り","ぬ","る","を","わ","か","よ","た","れ","そ","つ","ね","な","ら","む","う","ゐ","の","お","く","や","ま","け","ふ","こ","え","て","あ","さ","き","ゆ","め","み","し","ゑ","ひ","も","せ","す"],katakana:["ア","ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヰ","ヱ","ヲ","ン"],"katakana-iroha":["イ","イ","ロ","ハ","ニ","ホ","ヘ","ト","チ","リ","ヌ","ル","ヲ","ワ","カ","ヨ","タ","レ","ソ","ツ","ネ","ナ","ラ","ム","ウ","ヰ","ノ","オ","ク","ヤ","マ","ケ","フ","コ","エ","テ","ア","サ","キ","ユ","メ","ミ","シ","ヱ","ヒ","モ","セ","ス"]},e={"upper-latin":"upper-alpha","lower-latin":"lower-alpha"};return{getTableByName:function(n){return t[e[n]||n]},getBaseByName:function(t){var e=this.getTableByName(t);return e.length},getStringByName:function(t,e){for(var n=this.getTableByName(t),i=n.length,r=c.convBase(e,i),s="",a=0;a<r.length;a++){var o=r[a],u=0===a?r[a]:Math.min(o+1,i-1);s+=n[u]||""}return s}}}(),W=function(){var t=document.createElement("canvas");t.style.width=Math.max(r.width,r.height)+"px",t.style.height=r.maxFontSize+"px";var e;return t.getContext&&(e=t.getContext("2d"),e.textAlign="left"),{isEnable:function(){return e&&"undefined"!=typeof e.measureText},getMetrics:function(t,n){return e.font=t.toString(),e.measureText(n)},getMeasure:function(t,e){var n=this.getMetrics(t,e),i=Math.floor(r.vertWordSpaceRate*t.size);return n.width+i}}}(),G=function(){function t(t){this.type=t}var e={disc:"&#x2022;",circle:"&#x25CB;",square:"&#x25A0;"};return t.prototype={isDecimalList:function(){return"decimal"===this.type||"decimal-leading-zero"===this.type},isNoneList:function(){return"none"===this.type},isMarkList:function(){return"disc"===this.type||"circle"===this.type||"square"===this.type},isCountableList:function(){return!this.isNoneList()&&!this.isMarkList()},isHankaku:function(){return"lower-alpha"===this.type||"upper-alpha"===this.type||"lower-roman"===this.type||"upper-roman"===this.type||this.isDecimalList()},isZenkaku:function(){return!this.isHankaku()},_getMarkerDigitString:function(t){return"decimal"===this.type?t.toString(10):"decimal-leading-zero"===this.type?10>t?"0"+t.toString(10):t.toString(10):D.getStringByName(this.type,t)},getMarkerHtml:function(t){var e=this.getMarkerText(t);return this.isZenkaku()?p.tagWrap("span",e,{"class":"nehan-tcy"}):e},getMarkerText:function(t){if(this.isNoneList())return g.space;if(this.isMarkList())return e[this.type]||"";var n=this._getMarkerDigitString(t);return n+"."}},t}(),j=function(){function t(t){this.pos=t}return t.prototype={isOutside:function(){return"outside"===this.pos},isInside:function(){return"inside"===this.pos}},t}(),K=function(){function t(t){this.image=t}return t.prototype={getMarkerHtml:function(){var t=this.image.url,e=this.image.width||r.fontSize,n=this.image.height||r.fontSize;return p.tagSingle("img",{src:t,"class":"nehan-list-image",width:e,height:n})}},t}(),q=function(){function t(t){this.type=new G(t.type||"none"),this.position=new j(t.position||"outside"),this.image="none"!==t.image?new K(t.image):null}return t.prototype={isMultiCol:function(){return this.position.isOutside()},isInside:function(){return this.position.isInside()},isImageList:function(){return null!==this.image},getMarkerHtml:function(t){return null!==this.image?this.image.getMarkerHtml(t):this.type.getMarkerHtml(t)}},t}(),U=function(){function t(t){this.dir=t}return t.prototype={init:function(t){this.dir=t},isHorizontal:function(){return"lr"===this.dir||"rl"===this.dir},isVertical:function(){return"tb"===this.dir},isLeftToRight:function(){return"lr"===this.dir},isRightToLeft:function(){return"rl"===this.dir}},t}(),$=function(){function t(t){U.call(this,t)}return o.extend(t,U),t.prototype.flip=function(){switch(this.dir){case"lr":case"rl":return"tb";case"tb":return r.getVertBlockdir();default:return""}},t.prototype.getCss=function(){var t={};return this.isHorizontal()&&(t["css-float"]="lr"===this.dir?"left":"right"),t},t.prototype.getPropBefore=function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},t.prototype.getPropAfter=function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}},t}(),X=function(){function t(t){U.call(this,t)}return o.extend(t,U),t.prototype.getPropStart=function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},t.prototype.getPropEnd=function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}},t}(),Z=function(){function t(t,e){this.inflow=new X(t),this.blockflow=new $(e)}return t.prototype={isTextLineFirst:function(){return this.isTextVertical()&&this.blockflow.isLeftToRight()?!0:!1},isBlockflowVertical:function(){return this.blockflow.isVertical()},isTextVertical:function(){return this.inflow.isVertical()},isTextHorizontal:function(){return this.inflow.isHorizontal()},getCss:function(){var t={};return y.copy(t,this.blockflow.getCss()),t},getName:function(){return[this.inflow.dir,this.blockflow.dir].join("-")},getTextHorizontalDir:function(){return this.isTextHorizontal()?this.inflow.dir:""},getProp:function(t){switch(t){case"start":return this.getPropStart();case"end":return this.getPropEnd();case"before":return this.getPropBefore();case"after":return this.getPropAfter()}},getPropStart:function(){return this.inflow.getPropStart()},getPropEnd:function(){return this.inflow.getPropEnd()},getPropBefore:function(){return this.blockflow.getPropBefore()},getPropAfter:function(){return this.blockflow.getPropAfter()},getPropExtent:function(){return this.isTextVertical()?"width":"height"},getPropMeasure:function(){return this.isTextVertical()?"height":"width"},getPropWidth:function(){return this.isTextVertical()?"extent":"measure"},getPropHeight:function(){return this.isTextVertical()?"measure":"extent"},getFlipFlow:function(){return this.isTextVertical()?r.getStdHoriFlow():r.getStdVertFlow()},getBoxSize:function(t,e){var n=new de(0,0);return n[this.getPropMeasure()]=t,n[this.getPropExtent()]=e,n}},t}(),Q={"tb-rl":new Z("tb","rl"),"tb-lr":new Z("tb","lr"),"lr-tb":new Z("lr","tb"),"rl-tb":new Z("rl","tb"),get:function(t,e){return this.getByName([t,e].join("-"))},getByName:function(t){return this[t]||null}},J={iter:function(t,e){u.iter(g.cssBoxDirs,function(n){t[n]&&e(n,t[n])})},setValue:function(t,e,n){return"undefined"!=typeof n.start&&this.setStart(t,e,n.start),"undefined"!=typeof n.end&&this.setEnd(t,e,n.end),"undefined"!=typeof n.before&&this.setBefore(t,e,n.before),"undefined"!=typeof n.after&&this.setAfter(t,e,n.after),t},setBefore:function(t,e,n){t[e.getPropBefore()]=n},setAfter:function(t,e,n){t[e.getPropAfter()]=n},setStart:function(t,e,n){t[e.getPropStart()]=n},setEnd:function(t,e,n){t[e.getPropEnd()]=n}},Y=function(){var t=function(t,e){var n={top:0,bottom:1,left:2,right:3};return[t,e].sort(function(t,e){return n[t]-n[e]})};return{getCornerName:function(e,n){var i=t(e,n);return[i[0],h.capitalize(i[1])].join("")}}}(),te=function(){function t(t){this.size=t}return t.prototype={isBold:function(){return this.weight&&"normal"!==this.weight&&"lighter"!==this.weight},toString:function(){return[this.weight||"normal",this.style||"normal",this.size+"px",this.family||"monospace"].join(" ")},getCss:function(){var t={};return this.size&&(t["font-size"]=this.size+"px"),this.weight&&(t["font-weight"]=this.weight),this.style&&(t["font-style"]=this.style),this.family&&(t["font-family"]=this.family),t}},t}(),ee=function(){function t(t){this._type=t,this.top=0,this.right=0,this.bottom=0,this.left=0}return t.prototype={clear:function(){this.top=0,this.right=0,this.bottom=0,this.left=0},clearBefore:function(t){this[t.getPropBefore()]=0},clearAfter:function(t){this[t.getPropAfter()]=0},copyTo:function(t){var e=this;return u.iter(g.cssBoxDirs,function(n){t[n]=e[n]}),t},getDirProp:function(t){return[this._type,t].join("-")},getCss:function(){var t={},e=this;return u.iter(["top","right","bottom","left"],function(n){var i=e[n];i>0&&(t[e.getDirProp(n)]=e[n]+"px")}),t},getWidth:function(){return this.left+this.right},getHeight:function(){return this.top+this.bottom},getMeasure:function(t){return t.isTextVertical()?this.getHeight():this.getWidth()},getExtent:function(t){return t.isBlockflowVertical()?this.getHeight():this.getWidth()},setSize:function(t,e){J.setValue(this,t,e)},setStart:function(t,e){this[t.getPropStart()]=e},setEnd:function(t,e){this[t.getPropEnd()]=e},setBefore:function(t,e){this[t.getPropBefore()]=e},setAfter:function(t,e){this[t.getPropAfter()]=e},getStart:function(t){return this[t.getPropStart()]},getEnd:function(t){return this[t.getPropEnd()]},getBefore:function(t){return this[t.getPropBefore()]},getAfter:function(t){return this[t.getPropAfter()]}},t}(),ne=function(){function t(){this.hori=0,this.vert=0}return t.prototype={setSize:function(t){this.hori=t[0],this.vert=t[1]},getCssValueHori:function(){return this.hori+"px"},getCssValueVert:function(){return this.vert+"px"}},t}(),ie=function(){function t(){this.topLeft=new ne,this.topRight=new ne,this.bottomRight=new ne,this.bottomLeft=new ne}return t.prototype={getArray:function(){return[this.topLeft,this.topRight,this.bottomRight,this.bottomLeft]},getCssValueHori:function(){return u.map(this.getArray(),function(t){return t.getCssValueHori()}).join(" ")},getCssValueVert:function(){return u.map(this.getArray(),function(t){return t.getCssValueVert()}).join(" ")},getCssValue:function(){return[this.getCssValueHori(),this.getCssValueVert()].join("/")},getCss:function(){var t={},e=this.getCssValue();return t["border-radius"]=e,u.iter(g.cssVenderPrefixes,function(n){var i=[n,"border-radius"].join("-");t[i]=e}),t},getCorner:function(t,e){var n=Y.getCornerName(t,e);return this[n]},setSize:function(t,e){"undefined"!=typeof e["start-before"]&&this.setStartBefore(t,e["start-before"]),"undefined"!=typeof e["start-after"]&&this.setStartAfter(t,e["start-after"]),"undefined"!=typeof e["end-before"]&&this.setEndBefore(t,e["end-before"]),"undefined"!=typeof e["end-after"]&&this.setEndAfter(t,e["end-after"])},setStartBefore:function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropBefore());n.setSize(e)},setStartAfter:function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropAfter());n.setSize(e)},setEndBefore:function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropBefore());n.setSize(e)},setEndAfter:function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropAfter());n.setSize(e)},clearBefore:function(t){this.setStartBefore(t,[0,0]),this.setEndBefore(t,[0,0])},clearAfter:function(t){this.setStartAfter(t,[0,0]),this.setEndAfter(t,[0,0])}},t}(),re=function(){function t(){}return t.prototype={setColor:function(t,e){var n=this;J.setValue(this,t,e),J.iter(this,function(t,e){n[t]=new V(e)})},getCss:function(){var t={};return J.iter(this,function(e,n){var i=["border",e,"color"].join("-");t[i]=n.getCssValue()}),t
}},t}(),se=function(){function t(){}return t.prototype={setStyle:function(t,e){J.setValue(this,t,e)},getCss:function(){var t={};return J.iter(this,function(e,n){var i=["border",e,"style"].join("-");t[i]=n}),t}},t}(),ae=function(){function t(){ee.call(this,"padding")}return o.extend(t,ee),t.prototype.clone=function(){return this.copyTo(new t)},t}(),oe=function(){function t(){ee.call(this,"margin")}return o.extend(t,ee),t.prototype.clone=function(){return this.copyTo(new t)},t}(),ue=function(){function t(){ee.call(this,"border")}return o.extend(t,ee),t.prototype.clone=function(){var e=this.copyTo(new t);return this.radius&&(e.radius=this.radius),this.style&&(e.style=this.style),this.color&&(e.color=this.color),e},t.prototype.clearBefore=function(t){this.setBefore(t,0),this.radius&&this.radius.clearBefore(t)},t.prototype.clearAfter=function(t){this.setAfter(t,0),this.radius&&this.radius.clearAfter(t)},t.prototype.getDirProp=function(t){return["border",t,"width"].join("-")},t.prototype.setRadius=function(t,e){this.radius=new ie,this.radius.setSize(t,e)},t.prototype.setColor=function(t,e){this.color=new re,this.color.setColor(t,e)},t.prototype.setStyle=function(t,e){this.style=new se,this.style.setStyle(t,e)},t.prototype.getCss=function(){var t=ee.prototype.getCss.call(this);return this.radius&&y.copy(t,this.radius.getCss()),this.color&&y.copy(t,this.color.getCss()),this.style&&y.copy(t,this.style.getCss()),t},t}(),le=function(){function t(t){this.value=t||"none"}var e="filled dot",n={"filled dot":"&#x2022;","open dot":"&#x25e6;","filled circle":"&#x25cf;","open circle":"&#x25cb;","filled double-circle":"&#x25c9;","open double-circle":"&#x25ce;","filled triangle":"&#x25b2;","open triangle":"&#x25b3;","filled sesame":"&#xfe45;","open sesame":"&#xfe46;"};return t.prototype={isEnable:function(){return"none"!=this.value},setValue:function(t){this.value=t},getText:function(){return this.isEnable()?n[this.value]||this.value||n[e]:""},getCss:function(){var t={};return t}},t}(),he=function(){function t(t){y.merge(this,{hori:"over",vert:"right"},t||{})}return t.prototype={getCss:function(){var t={};return t}},t}(),ce=function(){function t(t){t=t||{},this.style=t.style||new le,this.pos=t.pos||new he,this.color=t.color||new V(r.fontColor)}return t.prototype={isEnable:function(){return this.style&&this.style.isEnable()},getText:function(){return this.style?this.style.getText():""},getExtent:function(t){return 3*t},getCssVertEmphaWrap:function(t,e){var n={},i=t.style.getFontSize();return n["text-align"]="left",n.width=this.getExtent(i)+"px",n.height=e.getAdvance(t.style.flow,t.style.letterSpacing||0)+"px",n},getCssHoriEmphaWrap:function(t,e){var n={},i=t.style.getFontSize();return n.display="inline-block",n.width=e.getAdvance(t.style.flow,t.style.letterSpacing)+"px",n.height=this.getExtent(i)+"px",n}},t}(),fe=function(){function t(t){this.address=this._normalize(t||"")}return t.prototype={_normalize:function(t){return t.replace(/\s/g,"")},getAddress:function(){return this.address},getAnchorName:function(){var t=this.address.indexOf("#");if(0>t)return"";var e=this.address.substring(t+1);return e.length>0?e:""}},t}(),ge=function(){function t(t){t=t||{},this.padding=t.padding||new ae,this.border=t.border||new ue,this.margin=t.margin||new oe}return t.prototype={clone:function(){var e=new t;return e.padding=this.padding.clone(),e.border=this.border.clone(),e.margin=this.margin.clone(),e},clear:function(){this.padding.clear(),this.border.clear(),this.margin.clear()},getCss:function(){var t={};return y.copy(t,this.padding.getCss()),y.copy(t,this.border.getCss()),y.copy(t,this.margin.getCss()),t},getWidth:function(){var t=0;return t+=this.padding.getWidth(),t+=this.border.getWidth(),t+=this.margin.getWidth()},getHeight:function(){var t=0;return t+=this.padding.getHeight(),t+=this.border.getHeight(),t+=this.margin.getHeight()},getMeasure:function(t){var e=0;return e+=this.padding.getMeasure(t),e+=this.border.getMeasure(t),e+=this.margin.getMeasure(t)},getExtent:function(t){var e=0;return e+=this.padding.getExtent(t),e+=this.margin.getExtent(t),e+=this.border.getExtent(t)},getInnerMeasureSize:function(t){var e=0;return e+=this.padding.getMeasure(t),e+=this.border.getMeasure(t)},getInnerExtentSize:function(t){var e=0;return e+=this.padding.getExtent(t),e+=this.border.getExtent(t)},getBefore:function(t){var e=0;return e+=this.padding.getBefore(t),e+=this.border.getBefore(t),e+=this.margin.getBefore(t)},getAfter:function(t){var e=0;return e+=this.padding.getAfter(t),e+=this.border.getAfter(t),e+=this.margin.getAfter(t)},setBorderRadius:function(t,e){this.border.setRadius(t,e)},setBorderColor:function(t,e){this.border.setColor(t,e)},setBorderStyle:function(t,e){this.border.setStyle(t,e)},clearBefore:function(t){this.padding.clearBefore(t),this.border.clearBefore(t),this.margin.clearBefore(t)},clearAfter:function(t){this.padding.clearAfter(t),this.border.clearAfter(t),this.margin.clearAfter(t)},clearBorderStart:function(t){this.border.clearStart(t)},clearBorderBefore:function(t){this.border.clearBefore(t)},clearBorderAfter:function(t){this.border.clearAfter(t)}},t}(),de=function(){function t(t,e){this.width=t,this.height=e}return t.prototype={clone:function(){return new t(this.width,this.height)},setExtent:function(t,e){this[t.getPropExtent()]=e},setMeasure:function(t,e){this[t.getPropMeasure()]=e},getCss:function(){var t={};return t.width=this.width+"px",t.height=this.height+"px",t},getMeasure:function(t){return this[t.getPropMeasure()]},getExtent:function(t){return this[t.getPropExtent()]}},t}(),pe=function(){function t(t){this.position=t}return t.prototype={isAbsolute:function(){return"absolute"===this.position},getCss:function(t){var e={};return e.position=this.position,this.start&&(e[t.getPropStart()]=this.start+"px"),this.end&&(e[t.getPropEnd()]=this.end+"px"),this.before&&(e[t.getPropBefore()]=this.before+"px"),this.after&&(e[t.getPropAfter()]=this.after+"px"),e}},t}(),me=function(){function t(t,e){this.size=t,this.style=e,this.css={}}var e=function(n){return u.fold(n,[],function(n,i){return n.concat(i instanceof t?e(i.elements||[]):i)})};return t.prototype={isAnonymousLine:function(){return"inline"===this.display&&this.style.isRootLine()},toLineString:function(){var t=e(this.elements||[]);return u.fold(t,"",function(t,e){return t+(e?e.data||"":"")})},getId:function(){return this.id||null},getClassName:function(){return this.classes?this.classes.join(" "):""},getContent:function(){return this.content||null},getOnCreate:function(){return this.isAnonymousLine()?null:this.style.getCssAttr("oncreate")},getAttrs:function(){return this.isAnonymousLine()?null:this.style.markup.attrs},getCssRoot:function(){switch(this.display){case"block":return this.getCssBlock();case"inline":return this.getCssInline();case"inline-block":return this.getCssInlineBlock()}},getCssBlock:function(){var t={};return y.copy(t,this.style.getCssBlock()),y.copy(t,this.size.getCss(this.style.flow)),this.edge&&y.copy(t,this.edge.getCss()),y.copy(t,this.css),t},getCssInline:function(){var t={};return y.copy(t,this.style.getCssInline()),y.copy(t,this.size.getCss(this.style.flow)),this.edge&&y.copy(t,this.edge.getCss()),y.copy(t,this.css),t},getCssInlineBlock:function(){var t=this.getCssBlock();return this.style.isFloated()||delete t["css-float"],t.display="inline-block",t},getContentMeasure:function(t){return t=t||this.style.flow,this.size.getMeasure(t)},getContentExtent:function(t){return t=t||this.style.flow,this.size.getExtent(t)},getContentWidth:function(){return this.size.width},getContentHeight:function(){return this.size.height},getEdgeMeasure:function(t){return t=t||this.style.flow,this.edge?this.edge.getMeasure(t):0},getEdgeExtent:function(t){return t=t||this.style.flow,this.edge?this.edge.getExtent(t):0},getLayoutMeasure:function(t){return t=t||this.style.flow,this.style.isPositionAbsolute()?0:this.getContentMeasure(t)+this.getEdgeMeasure(t)},getLayoutExtent:function(t){return t=t||this.style.flow,this.style.isPositionAbsolute()?0:this.getContentExtent(t)+this.getEdgeExtent(t)},clearBorderBefore:function(){this.edge&&this.edge.clearBorderBefore(this.style.flow)},clearBorderAfter:function(){this.edge&&this.edge.clearBorderAfter(this.style.flow)},resizeExtent:function(t,e){return this.size.setExtent(t,e),this}},t}(),ye=function(){function t(t){this.pos=0,this.buff=this._normalize(t),this.src=this.buff}var e=/\d\d|!\?|!!|\?!|\?\?/,n=/^[\w!\.\?\/\_:#;"',]+/,r=/^<[^>]+>/,a=/^&[^;\s]+;/,o=function(t,e,n,i){var r=t.indexOf(i);if(0>r)return-1;var s=t.match(n),a=s?s.index:-1;if(0>a||a>r)return r;var u=a+e.length+2,l=o(t.substring(u),e,n,i);if(0>l)return-1;var h=u+l+e.length+3;return h+o(t.substring(h),e,n,i)};return t.prototype={_normalize:function(t){return t.replace(/(<\/[^>]+>)/g,function(t){return t.toLowerCase()}).replace(/^[ \n]+/,"").replace(/\s+$/,"").replace(/\r/g,"")},isEmpty:function(){return""===this.src},get:function(){var t=this._getToken();return t&&(t.spos=this.pos),t},getSrc:function(){return this.src},getSeekPercent:function(t){return Math.round(100*t/this.src.length)},addText:function(t){this.buff=this.buff+this._normalize(t)},_stepBuff:function(t){this.pos+=t,this.buff=this.buff.slice(t)},_getToken:function(){if(""===this.buff)return null;var t;return(t=this._getByRex(r))?this._parseTag(t):(t=this._getByRex(n))?1===t.length?this._parseChar(t):2===t.length&&t.match(e)?this._parseTcy(t):this._parseWord(t):(t=this._getByRex(a),t?this._parseCharRef(t):this._parseChar(this._getChar()))},_getByRex:function(t){var e=this.buff.match(t);return e?e[0]:null},_getRb:function(){var t=this.buffRb.substring(0,1);return this.buffRb=this.buffRb.slice(1),t},_getChar:function(){return this.buff.substring(0,1)},_getTagContent:function(t){var e=new RegExp("<"+t+"[\\s|>]"),n="</"+t+">",r=o(this.buff,t,e,n);if(r>=0)return{closed:!0,content:this.buff.substring(0,r)};if(i.enableAutoCloseTag){var s=this.buff.match(e);if(s)return{closed:!1,content:this.buff.substring(0,nexd_open_match.index)}}return{closed:!1,content:this.buff}},_parseTag:function(t){var e=new B(t);this._stepBuff(t.length);var n=e.getName();return s.isSingleTag(n)?(e._single=!0,e):this._parseChildContentTag(e)},_parseTcyTag:function(t){var e=this._getTagContent(t.name);return this._stepBuff(e.length+t.name.length+3),new L(e)},_parseChildContentTag:function(t){var e=this._getTagContent(t.name);return t.setContent(h.trimCRLF(e.content)),this._stepBuff(e.closed?e.content.length+t.name.length+3:e.content.length),t},_parseWord:function(t){return this._stepBuff(t.length),new P(t)},_parseTcy:function(t){return this._stepBuff(t.length),new L(t)},_parseChar:function(t){return this._stepBuff(t.length),new z(t,!1)},_parseCharRef:function(t){return this._stepBuff(t.length),new z(t,!0)}},t}(),xe=function(){function t(t,e,n){this.rank=t,this.title=e,this._id=n||0}return t.prototype={getId:function(){return this._id}},t}(),be=function(){function t(t,e,n){this._type=t,this._header=null,this._auto=!1,this._next=null,this._child=null,this._parent=e||null,this._pageNo=n||0}return t.prototype={isRoot:function(){return null===this._parent},isAuto:function(){return this._auto},hasHeader:function(){return null!==this._header},hasHeaderId:function(){return this.getHeaderId()>0},hasChild:function(){return null!==this._child},hasNext:function(){return null!==this._next},getNext:function(){return this._next},getChild:function(){return this._child},getParent:function(){return this._parent},getHeader:function(){return this._header},getHeaderId:function(){return this._header?this._header.getId():null},setHeader:function(t){this._header=t},setAuto:function(){this._auto=!0},getRank:function(){return this._header?this._header.rank:0},getTitle:function(){return this._header?this._header.title:["untitled",this._type].join(" ")},getType:function(){return this._type},getPageNo:function(){return this._pageNo},updatePageNo:function(t){this._pageNo=t},addChild:function(t){null===this._child?this._child=t:this._child.addNext(t)},addNext:function(t){null===this._next?this._next=t:this._next.addNext(t)}},t}(),ve=function(){function t(){this.stack=[1]}return t.prototype={toString:function(){return this.stack.join(".")},stepNext:function(){return this.stack.length>0&&this.stack[this.stack.length-1]++,this},startRoot:function(){return this.stack.push(1),this},endRoot:function(){return this.stack.pop(),this}},t}(),_e=function(){function t(t){this.logs=[],this.markupName=t}return t.prototype={isEmpty:function(){return 0===this.logs.length},get:function(t){return this.logs[t]||null},getMarkupName:function(){return this.markupName},startSection:function(t){return this.logs.push({name:"start-section",type:t,pageNo:Se.getPageNo()}),this},endSection:function(t){return this.logs.push({name:"end-section",type:t}),this},addHeader:function(t){var e=Se.genHeaderId();return this.logs.push({name:"set-header",type:t.type,rank:t.rank,title:t.title,pageNo:Se.getPageNo(),headerId:e}),e}},t}(),ke=function(){var t=function(e,n,i){var r=e.get(i++);if(null!==r){switch(r.name){case"start-section":var s=new be(r.type,n,r.pageNo);n&&n.addChild(s),t(e,s,i);break;case"end-section":t(e,n.getParent(),i);break;case"set-header":var a=new xe(r.rank,r.title,r.headerId);if(null===n){var o=new be("section",null,r.pageNo);o.setHeader(a),t(e,o,i)}else if(n.hasHeader()){var u=r.rank,l=n.getRank();if(l>u)i=Math.max(0,i-1),t(e,n.getParent(),i);else if(r.rank==l){var h=new be("section",n,r.pageNo);h.setHeader(a),n.addNext(h),t(e,h,i)}else{var c=new be("section",n,r.pageNo);c.setHeader(a),n.addChild(c),t(e,c,i)}}else n.setHeader(a),t(e,n,i)}return n}};return{parse:function(e){var n=0,i=new be("section",null,0);return t(e,i,n)}}}(),Ce=function(){var t={onClickLink:function(){return!1},createToc:function(t,e){return{tocPos:t.toString(),title:e.getTitle(),pageNo:e.getPageNo(),headerId:e.getHeaderId()}},createRoot:function(){var t=document.createElement("ul");return t.className="nehan-toc-root",t},createChild:function(){var t=document.createElement("li");return t.className="nehan-toc-item",t},createLink:function(t){var e=document.createElement("a"),n=t.title.replace(/<a[^>]+>/gi,"").replace(/<\/a>/gi,"");return e.href="#"+t.pageNo,e.innerHTML=n,e.className="nehan-toc-link",e.id=d.addNehanTocLinkPrefix(t.tocId),e},createPageNoItem:function(){return null}},e=function(t,n,i,r){if(null===i)return n;var s=r.createToc(t,i),a=r.createChild(s),o=r.createLink(s);o&&(o.onclick=function(){return r.onClickLink(s)},a.appendChild(o));var u=r.createPageNoItem(s);u&&a.appendChild(u),n.appendChild(a);var l=i.getChild();if(l){t=t.startRoot();var h=r.createToc(t,l),c=r.createRoot(h);e(t,c,l,r),a.appendChild(c),t=t.endRoot()}var f=i.getNext();return f&&e(t.stepNext(),n,f,r),n};return{convert:function(n,i){i=y.merge({},t,i||{});var r=new ve,s=i.createRoot();return e(r,s,n,i)}}}(),we=function(){function t(){this.title="",this.metas=[],this.links=[],this.scripts=[],this.styles=[]}return t.prototype={setTitle:function(t){this.title=t},getTitle:function(){return this.title},addLink:function(t){this.links.push(t)},getLinks:function(){return this.links},addMeta:function(t){this.metas.push(t)},getMetas:function(){return this.metas},getMetaByName:function(t){return u.find(this.metas,function(e){return e.getTagAttr("name")===t})},getMetaContentByName:function(t){var e=this.getMetaByName(t);return e?e.getTagAttr("content"):null},addScript:function(t){this.scripts.push(t)},getScripts:function(){return this.scripts},addStyle:function(t){this.styles.push(t)},getStyles:function(){return this.styles}},t}(),Se=function(){var t="html",e=null,n=0,i=0,r={},s=[],a=0,o=0,l=0,h=function(t){return u.filter(s,function(e){return e.getMarkupName()===t})},c=function(t,e){var n=ke.parse(t);return n?Ce.convert(n,e):null},f=function(t,e){var n=h(t);return u.fold(n,[],function(t,n){var i=c(n,e);return i?t.concat(i):t})};return{setDocumentType:function(e){t=e},getDocumentType:function(){return t},setDocumentHeader:function(t){e=t},getDocumentHeader:function(){return e},stepCharPos:function(t){i+=t},getCharPos:function(){return i},stepPageNo:function(){n++},getPageNo:function(){return n},addOutlineContext:function(t){s.push(t)},addAnchor:function(t){r[t]=n},getAnchorPageNo:function(t){return"undefined"==typeof r[t]?null:r[t]},genHeaderId:function(){return[Nehan.engineId,a++].join("-")},genRootBlockId:function(){return l++},genBlockId:function(){return o++},createBodyOutlineElement:function(t){var e=f("body",t);return 0===e.length?null:e[0]},createOutlineElementsByName:function(t,e){return f(t,e)}}}(),Ee=function(){function t(t){this.lexer=this._createLexer(t),this.tokens=[],this.pos=0,this.eof=!1,this._doBuffer()}return t.prototype={hasNext:function(){return!this.eof||this.pos<this.tokens.length},isEmptyLexer:function(){return this.lexer.isEmpty()},isEmptyTokens:function(){return 0===this.tokens.length},isHead:function(){return 0===this.pos},addText:function(t){this.eof&&""!==t&&(this.lexer.addText(t),this.eof=!1)},prev:function(){this.pos=Math.max(0,this.pos-1)},setPos:function(t){this.pos=t},rewind:function(){this.pos=0},peek:function(t){var e=t||0,n=Math.max(0,this.pos+e);if(n>=this.tokens.length){if(this.eof)return null;this._doBuffer()}var i=this.tokens[n];return i?(i.pos=n,i):null},get:function(){var t=this.peek();return this.pos++,t},getSrc:function(){return this.lexer.getSrc()},getPos:function(){return this.pos},getTokenCount:function(){return this.tokens.length},getSeekPos:function(){var t=this.tokens[this.pos];return t?t.spos:0},getSeekPercent:function(){var t=this.getSeekPos();return this.lexer.getSeekPercent(t)},getAll:function(){for(;!this.eof;)this._doBuffer();return this.tokens},getAllIf:function(t){return u.filter(this.getAll(),function(e){return t(e)})},iterWhile:function(t){for(var e;this.hasNext();)if(e=this.get(),null===e||!t(e)){this.prev();break}},skipUntil:function(t){for(;this.hasNext();){var e=this.get();if(null===e)break;if(!t(e)){this.prev();break}}},_createLexer:function(t){return new ye(t)},_doBuffer:function(){for(var t=i.lexingBufferLen,e=0;t>e;e++){var n=this.lexer.get();if(null===n){this.eof=!0;break}this.tokens.push(n)}}},t}(),Me=function(){function t(t,e){Ee.call(this,t);var n=0;this.tokens=this.getAllIf(function(t){return I.isText(t)?!1:e(t)?(t.order=n++,!0):void 0})}return o.extend(t,Ee),t}(),Ne=function(){function t(t){Me.call(this,t,function(t){var e=t.getName();return"!doctype"===e||"html"===e}),this.isEmptyTokens()&&(this.tokens=[new B("html",t)])}return o.extend(t,Me),t}(),Ae=function(){function t(t){Me.call(this,t,function(t){var e=t.getName();return"head"===e||"body"===e})}return o.extend(t,Me),t}(),Te=function(){function t(t){Me.call(this,t,function(t){var e=t.getName();return"title"===e||"meta"===e||"link"===e||"style"===e||"script"===e})}return o.extend(t,Me),t}(),Be=function(){function t(t){Ee.call(this,t.getContent()),this.getAll(),this.tokens=this._parse(t),this.rewind()}return o.extend(t,Ee),t.prototype._parse=function(t){for(var e=[];this.hasNext();)e.push(this._parseRuby(t));return e},t.prototype._parseRuby=function(){for(var t=[],e=null;;){var n=this.get();if(null===n)break;if(I.isTag(n)&&"rt"===n.getName()){e=n;break}I.isText(n)&&t.push(n)}return new R(t,e)},t}(),Ie=function(){function t(t){y.merge(this,{element:null,seekPos:0,pageNo:0,charPos:0,charCount:0,percent:0},t)}return t}(),ze=function(){function t(){this.evaluator=this._getEvaluator()}return t.prototype={_getEvaluator:function(){return"vert"===r.direction?new wn:new Sn},evaluate:function(t){return t?new Ie({element:this.evaluator.evaluate(t),percent:t.percent,seekPos:t.seekPos,pageNo:t.pageNo,charPos:t.charPos,charCount:t.charCount}):null}},t}(),Pe=function(){function t(t){this.text=this._createSource(t),this._trees=[],this._pages=[],this.generator=this._createGenerator(this.text),this.evaluator=this._createEvaluator()}return t.prototype={hasPage:function(t){return"undefined"!=typeof this._trees[t]},hasNext:function(){return this.generator.hasNext()},addText:function(t){this.generator.addText(t)},setTerminate:function(t){this.generator.setTerminate(t)},syncGet:function(){var t=0;for(this._setTimeStart();this.hasNext();)if(!this.hasPage(t)){var e=this._yield();e&&(this._addTree(e),t++)}return this._getTimeElapsed()},asyncGet:function(t){y.merge(this,{onComplete:function(){},onProgress:function(){},onError:function(){}},t||{}),this._setTimeStart(),this._asyncGet(t.wait||0)},getPageCount:function(){return this._trees.length},get:function(t){return this.getPage(t)},getPage:function(t){if(this._pages[t])return this._pages[t];var e=this._trees[t]||null;if(null===e)return null;var n=this.evaluator.evaluate(e);return this._pages[t]=n,n},getTree:function(t){return this._trees[t]||null},_yield:function(){return this.generator.yield()},_setTimeStart:function(){return this._timeStart=(new Date).getTime(),this._timeStart},_getTimeElapsed:function(){return(new Date).getTime()-this._timeStart},_asyncGet:function(t){if(!this.generator.hasNext())return void this.onComplete(this,this._getTimeElapsed());var e=this._yield();e&&(this._addTree(e),this.onProgress(this,e));var n=this;f(function(){n._asyncGet(t)})},_addTree:function(t){this._trees.push(t)},_createSource:function(t){return t.replace(/\t/g,"").replace(/<!--[\s\S]*?-->/g,"").replace(/<rp>[^<]*<\/rp>/gi,"").replace(/<rb>/gi,"").replace(/<\/rb>/gi,"").replace(/<rt><\/rt>/gi,"")},_createGenerator:function(t){switch(r.root){case"document":return new kn(t);case"html":return new _n(t);default:return new vn(t)}},_createEvaluator:function(){return new ze}},t}(),Le={set:function(t,e,n){t.isKakkoStart()?this._setKerningStart(t,e):(t.isKakkoEnd()||t.isKutenTouten())&&this._setKerningEnd(t,n)},_setKerningStart:function(t,e){var n=this._getTextSpaceStart(t,e);n>0&&(t.spaceRateStart=n)},_setKerningEnd:function(t,e){var n=this._getTextSpaceEnd(t,e);n>0&&(t.spaceRateEnd=n)},_getTextSpaceStart:function(t,e){return null===e?.5:I.isChar(e)&&e.isKakkoStart()?0:.5},_getTextSpaceEnd:function(t,e){return null===e?.5:I.isChar(e)&&(e.isKakkoEnd()||e.isKutenTouten())?0:.5}},Re=function(){function t(t){this.value=t||"none"}return t.prototype={getCss:function(t){var e={};return t.isTextHorizontal()&&(this.isStart()?e["css-float"]="left":this.isEnd()&&(e["css-float"]="right")),e},isStart:function(){return"start"===this.value},isEnd:function(){return"end"===this.value},isNone:function(){return"none"===this.value}},t}(),Fe={start:new Re("start"),end:new Re("end"),none:new Re("none"),get:function(t){return this[t]||null}},Ve=function(){function t(t){this.value=t}return t.prototype={isAlways:function(){return"always"===this.value},isAvoid:function(){return"avoid"===this.value},isFirst:function(){return"lr"===r.getPagingDirection()?"left"===this.value:"right"===this.value},isSecond:function(){return"lr"===r.getPagingDirection()?"right"===this.value:"left"===this.value},isNth:function(){}},t}(),He={before:{always:new Ve("always"),avoid:new Ve("avoid"),left:new Ve("left"),right:new Ve("right"),first:new Ve("first"),second:new Ve("second")},after:{always:new Ve("always"),avoid:new Ve("avoid"),left:new Ve("left"),right:new Ve("right"),first:new Ve("first"),second:new Ve("second")},getBefore:function(t){return this.before[t]||null},getAfter:function(t){return this.after[t]||null}},Oe=function(){function t(t){this.value=t||"start"}return t.prototype={isStart:function(){return"start"===this.value},isEnd:function(){return"end"===this.value},isCenter:function(){return"center"===this.value},getCss:function(){var t={};return"center"===this.value,t}},t}(),De={start:new Oe("start"),end:new Oe("end"),center:new Oe("center"),get:function(t){return this[t]||null}},We=function(){function t(t){this.weight=t.weight||0,this.isStatic=t.isStatic||!1}return t.prototype={getSize:function(t,e){return Math.floor(t*this.weight/e)},mergeTo:function(t){return this.isStatic&&!t.isStatic?this:!this.isStatic&&t.isStatic?t:this.weight>t.weight?this:t}},t}(),Ge=function(){function t(t){this._punits=t||[]}var e=function(t,e){var n=u.filter(t,function(t){return e>t});if(0===n.length)return t;var i=u.fold(n,0,function(t,n){return t+(e-n)}),r=u.filter(t,function(t){return t-e>=e});if(0===r.length)return t;var s=Math.floor(i/r.length);return u.map(t,function(t){return e>t?e:t-e>=e?t-s:t})};return t.prototype={get:function(t){return this._punits[t]||null},getLength:function(){return this._punits.length},getTotalWeight:function(){return u.fold(this._punits,0,function(t,e){return t+e.weight})},mergeTo:function(e){if(this.getLength()!==e.getLength())throw"Partition::mergeTo, invalid merge target(length not same)";var n=u.mapi(this._punits,function(t,n){return n.mergeTo(e.get(t))});return new t(n)},mapMeasure:function(t){var n=this.getTotalWeight(),i=u.map(this._punits,function(e){return e.getSize(t,n)});return e(i,r.minTableCellSize)}},t}(),je=function(){function t(){x.call(this)}return o.extend(t,x),t.prototype.merge=function(t,e){return t.mergeTo(e)},t.prototype.getSizes=function(t){var e=this.get(t.partitionCount);return e.mapMeasure(t.measure)},t}(),Ke={parse:function(t,e){for(var n=new je;e.hasNext();){var i=e.get();if(null===i)break;if(I.isTag(i))switch(i.getName()){case"tbody":case"thead":case"tfoot":var r=this.parse(t,this._getRowStream(i));n=n.union(r);break;case"tr":var s=this._getCellStream(i).getAll(),a=s.length,o=this._getPartition(t,s);n.add(a,o)}}return n},_getPartition:function(t,e){var n=this,i=e.length,r=u.map(e,function(e){return n._getPartitionUnit(t,e,i)});return new Ge(r)},_getPartitionUnit:function(t,e,n){var i=e.getAttr("measure")||e.getAttr("width")||null;if(i)return new We({weight:i,isStatic:!0});var r=(e.getContent(),e.getContent().replace(/<br \/>/g,"\n").replace(/<br>/g,"\n").split("\n")),s=u.maxobj(r,function(t){return t.length}),a=Math.floor(t.contentMeasure/2),o=Math.floor(t.contentMeasure/(2*n)),l=s.length*t.getFontSize();return l=Math.max(o,Math.min(l,a)),l=Math.max(t.getFontSize(),l),new We({weight:l,isStatic:!1})},_getCellStream:function(t){return new Me(t.getContent(),function(t){return I.isTag(t)&&("td"===t.getName()||"th"===t.getName())})},_getRowStream:function(t){return new Me(t.getContent(),function(t){return I.isTag(t)&&"tr"===t.getName()})}},qe=function(){function t(t,e){this._style=t,this._cursorContext=e||null}return t.prototype={getParentStyleContext:function(){return this._style.parent},getParentFlow:function(){var t=this.getParentStyleContext();return t?t.flow:r.getStdBoxFlow()},getMarkup:function(){return this._style.markup},getDocumentContext:function(){return Se},getRestMeasure:function(){return this._cursorContext?this._cursorContext.getInlineRestMeasure():null},getRestExtent:function(){return this._cursorContext?this._cursorContext.getBlockRestExtent():null},getChildIndex:function(){return this._style.getChildIndex()},getChildIndexOfType:function(){return this._style.getChildIndexOfType}},t}(),Ue=function(){function t(t,e){qe.call(this,t,e)}return o.extend(t,qe),t.prototype.isTextVertical=function(){var t=this.getParentFlow(),e=this.getCssAttr("flow",t.getName()),n=Q.getByName(e);return n&&n.isTextVertical()?!0:!1},t.prototype.isTextHorizontal=function(){return this.isTextVertical()===!1},t.prototype.getCssAttr=function(t,e){return this._style.getCssAttr(t,e)},t.prototype.setCssAttr=function(t,e){this._style.setCssAttr(t,e)},t}(),$e=function(){function t(t,e,n){this._initialize(t,e,n)}var e=/(^(<[^>]+>|[\s\n])*)(\S)/im,n=["script","noscript","style","input","iframe","form"],s=["border-color","border-radius","border-style","border-width","box-sizing","break-after","break-before","color","display","extent","embeddable","float","flow","font-family","font-size","font-style","font-weight","height","interactive","letter-spacing","line-rate","list-style-type","list-style-position","list-style-image","margin","measure","meta","onload","oncreate","padding","position","section","section-root","text-align","text-emphasis-style","text-emphasis-position","text-emphasis-color","text-combine","width","word-break"],a=function(t){return u.exists(s,m.eq(t))},o=function(t){var e=[];return u.iter(t,function(t){t instanceof me!=!1&&(t.style.isTextEmphaEnable()||"ruby"===t.style.getMarkupName()?e.push(t):t.elements&&(e=e.concat(o(t.elements))))}),e};return t.prototype={_initialize:function(t,e,n){n=n||{},this.markup=t,this.markupName=t.getName(),this.parent=e||null,this.childs=[],this.next=null,this.prev=null,e&&e.appendChild(this),this.selectorPropContext=new qe(this,n.cursorContext||null),this.selectorContext=new Ue(this,n.cursorContext||null),this.managedCss=new b,this.unmanagedCss=new b,this.managedCss.addValues(this._loadSelectorCss(t,e)),this.managedCss.addValues(this._loadInlineCss(t)),this.managedCss.addValues(this._loadCallbackCss(this.managedCss,"onload")),this.managedCss.addValues(n.forceCss,{}),this.unmanagedCss.addValues(this._loadUnmanagedCss(this.managedCss)),this.display=this._loadDisplay(),this.flow=this._loadFlow(),this.boxSizing=this._loadBoxSizing();var i=this._loadColor();i&&(this.color=i);var r=this._loadFont();r&&(this.font=r);var s=this._loadPosition();s&&(this.position=s);var a=this._loadEdge(this.flow,this.getFontSize());a&&(this.edge=a);var o=this._loadLineRate();o&&(this.lineRate=o);var u=this._loadTextAlign();u&&(this.textAlign=u);var l=this._loadTextEmpha();l&&(this.textEmpha=l);var h=this._loadTextCombine();h&&(this.textCombine=h);var c=this._loadListStyle();c&&(this.listStyle=c);var f=this._loadFloatDirection();f&&(this.floatDirection=f);var g=this._loadBreakBefore();g&&(this.breakBefore=g);var d=this._loadBreakAfter();d&&(this.breakAfter=d);var p=this._loadWordBreak();p&&(this.wordBreak=p),this.staticMeasure=this._loadStaticMeasure(),this.staticExtent=this._loadStaticExtent(),this.initContextSize(this.staticMeasure,this.staticExtent),"table"===this.display&&"auto"===this.getCssAttr("table-layout")&&(this.tablePartition=Ke.parse(this,new Ee(this.getContent()))),this._disableUnmanagedCssProps(this.unmanagedCss)},getOutlineContext:function(){return this.outlineContext||this.parent.getOutlineContext()},startOutlineContext:function(){this.outlineContext=new _e(this.getMarkupName())},endOutlineContext:function(){Se.addOutlineContext(this.getOutlineContext())},startSectionContext:function(){this.getOutlineContext().startSection(this.getMarkupName())},endSectionContext:function(){this.getOutlineContext().endSection(this.getMarkupName())},startHeaderContext:function(t){return this.getOutlineContext().addHeader({type:t.type,rank:t.rank,title:t.title})},initContextSize:function(t,e){this.outerMeasure=t||(this.parent?this.parent.contentMeasure:r.getMeasure(this.flow)),this.outerExtent=e||(this.parent?this.parent.contentExtent:r.getExtent(this.flow)),this.contentMeasure=this._computeContentMeasure(this.outerMeasure),this.contentExtent=this._computeContentExtent(this.outerExtent)},updateContextSize:function(t,e){this.forceUpdateContextSize(this.staticMeasure||t,this.staticExtent||e)},forceUpdateContextSize:function(t,e){this.initContextSize(t,e),u.iter(this.childs,function(t){t.forceUpdateContextSize(null,null)})},clone:function(e){if(null===this.parent)return this.createChild("div",e);var n=new t(this.markup,this.parent,{forceCss:e||{}});return n.parent.removeChild(n),n.setClone(!0),n},appendChild:function(t){if(this.childs.length>0){var e=u.last(this.childs);e.next=t,t.prev=e}this.childs.push(t)},removeChild:function(t){var e=u.indexOf(this.childs,function(e){return e===t});if(e>=0){var n=this.childs.splice(e,1);return n}return null},createChild:function(e,n,i){var r=new B("<"+e+">");return r.setAttrs(i||{}),new t(r,this,{forceCss:n||{}})},setListItemCount:function(t){var e=this.getListMarkerHtml(t),n=new tn(this.clone(),new Ee(e)),i=n.yield(),r=i?i.inlineMeasure+Math.floor(this.getFontSize()/2):this.getFontSize(),s=i?i.size.getExtent(this.flow):this.getFontSize();this.listMarkerSize=this.flow.getBoxSize(r,s)},isClone:function(){return this._isClone||!1},setClone:function(t){this._isClone=t},createBlock:function(t){t=t||{};
var e=t.elements||[],n=this.contentMeasure,i=this.parent&&t.extent&&null===this.staticExtent?t.extent:this.contentExtent,r=["nehan-block","nehan-"+this.getMarkupName()].concat(this.markup.getClasses()),s=this.flow.getBoxSize(n,i),a=new me(s,this);return this.markup.isHeaderTag()&&r.push("nehan-header"),this.isClone()&&r.push("nehan-clone"),"undefined"!=typeof t.rootBlockId&&(a.rootBlockId=t.rootBlockId),a.blockId=t.blockId,a.display="inline-block"===this.display?this.display:"block",a.edge=this._createBlockContextEdge(this.edge||null,t.cancelEdge||null),a.elements=e,a.classes=r,a.charCount=u.fold(e,0,function(t,e){return t+(e?e.charCount||0:0)}),a.breakAfter=this.isBreakAfter()||t.breakAfter||!1,a.content=t.content||null,this.isPushed()?a.pushed=!0:this.isPulled()&&(a.pulled=!0),a},_createBlockContextEdge:function(t,e){if(null===t)return null;if(null===e||0===e.before&&0===e.after)return t;var n=t.clone();return e.before&&n.clearBefore(this.flow),e.after&&n.clearAfter(this.flow),n},createImage:function(t){t=t||{};var e=this.getMarkupAttr("width")?parseInt(this.getMarkupAttr("width"),10):this.staticMeasure||this.font.size,n=this.getMarkupAttr("height")?parseInt(this.getMarkupAttr("height"),10):this.staticExtent||this.font.size,i=["nehan-block","nehan-image"].concat(this.markup.getClasses()),r=new de(e,n),s=new me(r,this);return s.display=this.display,s.edge=this.edge||null,s.classes=i,s.charCount=0,this.isPushed()?s.pushed=!0:this.isPulled()&&(s.pulled=!0),s.breakAfter=this.isBreakAfter()||t.breakAfter||!1,s},createLine:function(t){t=t||{};var e=t.elements||[],n=t.maxFontSize||this.getFontSize(),i=t.maxExtent||0,r=t.charCount||0,s=t.content||null;i=this.isTextEmphaEnable()?Math.max(i,this.getEmphaLineExtent()):"ruby"===this.markup.name?Math.max(i,this.getRubyLineExtent()):Math.max(i,this.getAutoLineExtent());var a=this.parent&&t.measure&&null===this.staticMeasure&&!this.isRootLine()?t.measure:this.contentMeasure;"inline-block"===this.display&&(a=this.staticMeasure||t.measure);var u=this.flow.getBoxSize(a,i),l=["nehan-inline","nehan-inline-"+this.flow.getName()].concat(this.markup.getClasses()),h=new me(u,this);if(h.display="inline",h.elements=e,h.classes=this.isRootLine()?l:l.concat("nehan-"+this.getMarkupName()),h.charCount=r,h.maxFontSize=n,h.maxExtent=i,h.content=s,h.edge=this.edge&&!this.isRootLine()?this.edge:null,this.isRootLine()){h.lineBreak=t.lineBreak||!1,h.breakAfter=t.breakAfter||!1,h.inlineMeasure=t.measure||this.contentMeasure,h.texts=t.texts||[];var c=o(e);this.isTextVertical()?this._setVertBaseline(e,c,n,i):0===c.length&&this.setCssAttr("line-height",i+"px"),this.textAlign&&!this.textAlign.isStart()&&this._setTextAlign(h,this.textAlign)}return h},isDisabled:function(){return"none"===this.display?!0:u.exists(n,m.eq(this.getMarkupName()))?!0:this.contentMeasure<=0||this.contentExtent<=0?!0:this.markup.isCloseTag()?!0:!this.markup.isSingleTag()&&this.isBlock()&&this.isMarkupEmpty()&&""===this.getContent()?!0:!1},isBlock:function(){switch(this.display){case"block":case"table":case"table-caption":case"table-header-group":case"table-row-group":case"table-footer-group":case"table-row":case"table-cell":case"list-item":return!0}return!1},isRoot:function(){return null===this.parent},isChildBlock:function(){return this.isBlock()&&!this.isRoot()},isInlineBlock:function(){return"inline-block"===this.display},isInline:function(){return"inline"===this.display},isRootLine:function(){return this.isBlock()||this.isInlineBlock()},isFloatStart:function(){return this.floatDirection&&this.floatDirection.isStart()},isFloatEnd:function(){return this.floatDirection&&this.floatDirection.isEnd()},isFloated:function(){return this.isFloatStart()||this.isFloatEnd()},isPushed:function(){return null!==this.getMarkupAttr("pushed")},isPulled:function(){return null!==this.getMarkupAttr("pulled")},isPasted:function(){return null!==this.getMarkupAttr("pasted")},isTextEmphaEnable:function(){return this.textEmpha&&this.textEmpha.isEnable()?!0:!1},isTextVertical:function(){return this.flow.isTextVertical()},isTextHorizontal:function(){return this.flow.isTextHorizontal()},isPositionAbsolute:function(){return this.position.isAbsolute()},isPre:function(){var t=this.getCssAttr("white-space","normal");return"pre"===t},isPageBreak:function(){switch(this.getMarkupName()){case"page-break":case"end-page":case"pbr":return!0;default:return!1}},isBreakBefore:function(){return this.breakBefore?!this.breakBefore.isAvoid():!1},isBreakAfter:function(){return this.breakAfter?!this.breakAfter.isAvoid():!1},isFirstChild:function(){var t=this.getParentChilds();return t.length>0&&t[0]===this},isFirstOfType:function(){var t=this.getParentChildsOfType(this.getMarkupName());return t.length>0&&t[0]===this},isLastChild:function(){return!1},isLastOfType:function(){return!1},isOnlyChild:function(){var t=this.getParentChilds();return 1===t.length&&t[0]===this},isOnlyOfType:function(){var t=this.getParentChildsOfType(this.getMarkupName());return 1===t.length&&t[0]===this},isMarkupEmpty:function(){return this.markup.isEmpty()},isWordBreakAll:function(){return this.wordBreak&&"break-all"===this.wordBreak},hasFlipFlow:function(){return this.parent?this.flow!==this.parent.flow:!1},clearBreakBefore:function(){this.breakBefore=null},clearBreakAfter:function(){this.breakAfter=null},getAttr:function(t,e){var n=this.getMarkupAttr(t);return"undefined"!=typeof n&&null!==n?n:(n=this.getCssAttr(t),"undefined"!=typeof n&&null!==n?n:"undefined"!=typeof e?e:null)},getMarkupAttr:function(t,e){return"id"===t?this.markup.id:this.markup.getAttr(t,e)},_evalCssAttr:function(t,e){return"oncreate"===t?e:"function"==typeof e?v.formatValue(t,e(this.selectorPropContext)):e},setCssAttr:function(t,e){a(t)?this.managedCss.add(t,e):this.unmanagedCss.add(t,e)},getCssAttr:function(t,e){var n;return n=this.managedCss.get(t),null!==n?this._evalCssAttr(t,n):(n=this.unmanagedCss.get(t),null!==n?this._evalCssAttr(t,n):"undefined"!=typeof e?e:null)},getParentMarkupName:function(){return this.parent?this.parent.getMarkupName():null},getMarkupName:function(){return this.markup.getName()},getMarkupId:function(){return this.markup.getId()},getMarkupClasses:function(){return this.markup.getClasses()},getMarkupContent:function(){return this.markup.getContent()},getMarkupPos:function(){return this.markup.pos},getMarkupData:function(t){return this.markup.getData(t)},getContent:function(){var t=this.markup.getContent(),n=M.getValuePe(this,"before");l.isEmpty(n)||(t=p.tagWrap("before",n.content||"")+t);var i=M.getValuePe(this,"after");l.isEmpty(i)||(t+=p.tagWrap("after",i.content||""));var r=M.getValuePe(this,"first-letter");l.isEmpty(r)||(t=t.replace(e,function(t,e,n,i){return e+p.tagWrap("first-letter",i)}));var s=M.getValuePe(this,"first-line");return l.isEmpty(s)||(t=p.tagWrap("first-line",t)),t},getHeaderRank:function(){return this.markup.getHeaderRank()},getFontSize:function(){return this.font.size},getFontFamily:function(){return this.font.family||r.fontFamily},getTextAlign:function(){return this.textAlign||De.get("start")},getTextCombine:function(){return this.textCombine||null},getLetterSpacing:function(){return this.letterSpacing||0},getListMarkerHtml:function(t){return this.listStyle?this.listStyle.getMarkerHtml(t):this.parent?this.parent.getListMarkerHtml(t):""},getListMarkerSize:function(){return this.listMarkerSize?this.listMarkerSize:this.parent?this.parent.getListMarkerSize():this.getFontSize()},getColor:function(){return this.color||(this.parent?this.parent.getColor():new V(r.fontColor))},getTablePartition:function(){return this.tablePartition||(this.parent?this.parent.getTablePartition():null)},getChildCount:function(){return this.childs.length},getChildIndex:function(){var t=this;return u.indexOf(this.getParentChilds(),function(e){return e===t})},getChildIndexOfType:function(){var t=this;return u.indexOf(this.getParentChildsOfType(this.getMarkupName()),function(e){return e===t})},getNthChild:function(t){return this.childs[t]||null},getParentChilds:function(){return this.parent?this.parent.childs:[]},getParentNthChild:function(t){return this.parent?this.parent.getNthChild(t):null},getParentChildsOfType:function(t){return u.filter(this.getParentChilds(),function(e){return e.getMarkupName()===t})},getParentFlow:function(){return this.parent?this.parent.flow:this.flow},getParentFontSize:function(){return this.parent?this.parent.getFontSize():r.fontSize},getParentContentMeasure:function(){return this.parent?this.parent.contentMeasure:r.getMeasure(this.flow)},getParentContentExtent:function(){return this.parent?this.parent.contentExtent:r.getExtent(this.flow)},getNextSibling:function(){return this.next},getLineRate:function(){return this.lineRate||r.lineRate||2},getEmphaLineExtent:function(){return 3*this.getFontSize()},getRubyLineExtent:function(){var t=this.getLineRate(),e=this.getFontSize(),n=Math.floor(e*t);return e%2===0?n:n+1},getAutoLineExtent:function(){return Math.floor(this.getFontSize()*this.getLineRate())},getEdgeMeasure:function(t){var e=this.edge||null;return e?e.getMeasure(t||this.flow):0},getEdgeExtent:function(t){var e=this.edge||null;return e?e.getExtent(t||this.flow):0},getBlockContextEdge:function(t){t=t||this.flow;var e=this.edge||null;return{before:e?e.getBefore(t):0,after:e?e.getAfter(t):0}},getInnerEdgeMeasure:function(t){var e=this.edge||null;return e?e.getInnerMeasureSize(t||this.flow):0},getInnerEdgeExtent:function(t){var e=this.edge||null;return e?e.getInnerExtentSize(t||this.flow):0},getCssBlock:function(){var t={};return t.display="block",this.font&&y.copy(t,this.font.getCss()),this.parent&&y.copy(t,this.parent.flow.getCss()),this.color&&y.copy(t,this.color.getCss()),this.letterSpacing&&!this.isTextVertical()&&(t["letter-spacing"]=this.letterSpacing+"px"),this.floatDirection&&y.copy(t,this.floatDirection.getCss(this.flow)),this.position&&y.copy(t,this.position.getCss()),this.zIndex&&(t["z-index"]=this.zIndex),this.unmanagedCss.copyValuesTo(t),t},getCssInline:function(){var t={};if(this.font&&y.copy(t,this.font.getCss()),this.color&&y.copy(t,this.color.getCss()),this.isRootLine()&&y.copy(t,this.flow.getCss()),this.isTextVertical())t["line-height"]="1em",Nehan.Env.client.isAppleMobileFamily()&&(t["letter-spacing"]="-0.001em"),"ruby"!==this.markup.getName()&&(t["margin-left"]=t["margin-right"]="auto",t["text-align"]="center");else{var e=this.getCssAttr("line-height");e&&(t["line-height"]=this._computeUnitSize(e,this.font.size)+"px")}return this.unmanagedCss.copyValuesTo(t),t},_computeContentMeasure:function(t){switch(this.boxSizing){case"margin-box":return t-this.getEdgeMeasure();case"border-box":return t-this.getInnerEdgeMeasure();case"content-box":return t;default:return t}},_computeContentExtent:function(t){switch(this.boxSizing){case"margin-box":return t-this.getEdgeExtent();case"border-box":return t-this.getInnerEdgeExtent();case"content-box":return t;default:return t}},_computeFontSize:function(t,e){var n=String(t).replace(/\/.+$/,""),i=r.fontSizeNames[n]||n,s=this.getParentFontSize(),a=this._computeUnitSize(i,e,s);return Math.min(a,r.maxFontSize)},_computeUnitSize:function(t,e,n){var i=String(t);if(i.indexOf("rem")>0){var s=parseFloat(i.replace("rem",""));return Math.round(r.fontSize*s)}if(i.indexOf("em")>0){var a=parseFloat(i.replace("em",""));return Math.round(e*a)}if(i.indexOf("pt")>0)return Math.round(4*parseInt(i,10)/3);if(i.indexOf("%")>0)return Math.round(n*parseInt(i,10)/100);var o=parseInt(i,10);return isNaN(o)?0:o},_computeCornerSize:function(t,e){var n={};for(var i in t)n[i]=[0,0],n[i][0]=this._computeUnitSize(t[i][0],e),n[i][1]=this._computeUnitSize(t[i][1],e);return n},_computeEdgeSize:function(t,e){var n={};for(var i in t)n[i]=this._computeUnitSize(t[i],e);return n},_setTextAlign:function(t,e){var n=t.getContentMeasure(this.flow),i=n-t.inlineMeasure;if(!(0>=i)){var r=new ae;if(e.isCenter()){var s=Math.floor(i/2);t.size.setMeasure(this.flow,n-s),r.setStart(this.flow,s),y.copy(t.css,r.getCss())}else e.isEnd()&&(t.size.setMeasure(this.flow,t.inlineMeasure),r.setStart(this.flow,i),y.copy(t.css,r.getCss()))}},_setVertBaseline:function(t,e,n,i){var r=this.flow,s=(this.getFontSize(),Math.floor(i/2));u.iter(t,function(t){t instanceof me&&"img"!==t.style.getMarkupName()&&"inline-block"!==t.style.display&&t.size.setExtent(r,i)}),u.iter(e,function(t){var e=t.style.getFontSize(),n=s-Math.floor(e/2);if(n>0){var i=t.style.edge?t.style.edge.clone():new ge;i.padding.setAfter(r,n),y.copy(t.css,i.getCss(r))}})},_loadSelectorCss:function(t,e){switch(t.getName()){case"before":case"after":case"first-letter":case"first-line":return M.getValuePe(e,t.getName());default:return M.getValue(this)}},_loadCallbackCss:function(t,e){var n=t.get(e);if(null===n||"function"!=typeof n)return{};var i=n(this.selectorContext)||{};for(var r in i)i[r]=this._evalCssAttr(r,i[r]);return i},_loadInlineCss:function(t){var e=t.getAttr("style");if(null===e||i.disableInlineStyle)return{};var n=e.indexOf(";")>=0?e.split(";"):[e];return u.fold(n,{},function(t,e){var n=e.split(":");if(n.length>=2){var i=h.trim(n[0]).toLowerCase(),r=h.trim(n[1]),s=v.formatProp(i),a=v.formatValue(i,r);t[s]=a}return t})},_loadUnmanagedCss:function(t){return t.filter(function(t){return!a(t)})},_disableUnmanagedCssProps:function(t){this.isTextVertical()&&t.remove("line-height")},_loadDisplay:function(){return this.getCssAttr("display","inline")},_loadFlow:function(){var t=this.getCssAttr("flow","inherit"),e=this.parent?this.parent.flow:r.getStdBoxFlow();return"inherit"===t?e:"flip"===t?e.getFlipFlow():Q.getByName(t)},_loadPosition:function(){var t=this.getCssAttr("position","static");if("start"===t)return null;var e=new pe(t),n=this;return u.iter(g.cssBoxDirsLogical,function(t){var i=n.getCssAttr(t,"auto");"auto"!==i&&(e[i]=n._computeUnitSize(start,n.font.size))}),e},_loadColor:function(){var t=this.getCssAttr("color","inherit");return"inherit"!==t?new V(t):void 0},_loadFont:function(){var t=this.parent?this.parent.font.size:r.fontSize,e=new te(t),n=this.getCssAttr("font-size","inherit");"inherit"!==n&&(e.size=this._computeFontSize(n,t));var i=this.getCssAttr("font-family","inherit");"inherit"!==i?e.family=i:null===this.parent&&(e.family=r.fontFamily);var s=this.getCssAttr("font-weight","inherit");"inherit"!==s&&(e.weight=s);var a=this.getCssAttr("font-style","inherit");return"inherit"!==a&&(e.style=a),e},_loadBoxSizing:function(){return this.getCssAttr("box-sizing","margin-box")},_loadEdge:function(t,e){var n=this._loadPadding(t,e),i=this._loadMargin(t,e),r=this._loadBorder(t,e);return null===n&&null===i&&null===r?null:new ge({padding:n,margin:i,border:r})},_loadEdgeSize:function(t,e){var n=this.getCssAttr(e);return null===n?null:this._computeEdgeSize(n,t)},_loadPadding:function(t,e){var n=this._loadEdgeSize(e,"padding");if(null===n)return null;var i=new ae;return i.setSize(t,n),i},_loadMargin:function(t,e){var n=this._loadEdgeSize(e,"margin");if(null===n)return null;var i=new oe;return i.setSize(t,n),this.prev&&"block"===this.prev.display&&!this.prev.isFloated()&&this.prev.edge&&this.flow===this.prev.flow&&"block"===this.display&&!this.isFloated()&&this.prev.edge.margin.getAfter(this.flow)>0&&i.getBefore(this.flow)>0&&this._cancelMargin(this.flow,i,this.prev.edge.margin),this.isInline()&&(i.clearBefore(t),i.clearAfter(t)),i},_cancelMargin:function(t,e,n){var i=n.getAfter(t),r=e.getBefore(t);i>=r?e.setBefore(t,0):e.setBefore(t,r-i)},_loadBorder:function(t,e){var n=this._loadEdgeSize(e,"border-width");if(null===n)return null;var i=new ue;i.setSize(t,n);var r=this.getCssAttr("border-radius");r&&i.setRadius(t,this._computeCornerSize(r,e));var s=this.getCssAttr("border-color");s&&i.setColor(t,s);var a=this.getCssAttr("border-style");return a&&i.setStyle(t,a),i},_loadLineRate:function(){var t=this.getCssAttr("line-rate","inherit");return"inherit"===t&&this.parent&&this.parent.lineRate?this.parent.lineRate:parseFloat(t||r.lineRate)},_loadTextAlign:function(){var t=this.getCssAttr("text-align","inherit");return"inherit"===t&&this.parent&&this.parent.textAlign?this.parent.textAlign:De.get(t||"start")},_loadTextEmpha:function(){var t=this.getCssAttr("text-emphasis-style","none");if("none"===t||"inherit"===t)return null;var e=this.getCssAttr("text-emphasis-position",{hori:"over",vert:"right"}),n=this.getCssAttr("text-emphasis-color");return new ce({style:new le(t),pos:new he(e),color:n?new V(n):this.getColor()})},_loadTextEmphaStyle:function(){var t=this.getCssAttr("text-emphasis-style","inherit");return"inherit"!==t?new le(t):null},_loadTextEmphaPos:function(){return this.getCssAttr("text-emphasis-position",{hori:"over",vert:"right"})},_loadTextEmphaColor:function(t){return this.getCssAttr("text-emphasis-color",t.getValue())},_loadTextCombine:function(){return this.getCssAttr("text-combine")},_loadFloatDirection:function(){var t=this.getCssAttr("float","none");return"none"===t?null:Fe.get(t)},_loadBreakBefore:function(){var t=this.getCssAttr("break-before");return t?He.getBefore(t):null},_loadBreakAfter:function(){var t=this.getCssAttr("break-after");return t?He.getAfter(t):null},_loadWordBreak:function(){return this.getCssAttr("word-break")},_loadListStyle:function(){var t=this.getCssAttr("list-style-type","none");return"none"===t?null:new q({type:t,position:this.getCssAttr("list-style-position","outside"),image:this.getCssAttr("list-style-image","none")})},_loadLetterSpacing:function(t){var e=this.getCssAttr("letter-spacing");return e?this._computeUnitSize(e,t):void 0},_loadStaticMeasure:function(){var t=this.flow.getPropMeasure(),e=this.getParentContentMeasure(),n=this.getAttr(t)||this.getAttr("measure")||this.getCssAttr(t)||this.getCssAttr("measure");return n?this._computeUnitSize(n,this.font.size,e):null},_loadStaticExtent:function(){var t=this.flow.getPropExtent(),e=this.getParentContentExtent(),n=this.getAttr(t)||this.getAttr("extent")||this.getCssAttr(t)||this.getCssAttr("extent");return n?this._computeUnitSize(n,this.font.size,e):null}},t}(),Xe=function(){function t(t,e){this.block=t,this.inline=e}return t.prototype={hasBlockSpaceFor:function(t,e){return this.block.hasSpaceFor(t,e)},hasBreakAfter:function(){return this.block.hasBreakAfter()||this.inline.hasBreakAfter()||!1},addBlockElement:function(t,e){this.block.addElement(t,e)},getBlockElements:function(){return this.block.getElements()},getBlockCurExtent:function(){return this.block.getCurExtent()},getBlockMaxExtent:function(){return this.block.getMaxExtent()},getBlockRestExtent:function(){return this.block.getRestExtent()},getBlockCancelEdge:function(t){return this.block.getCancelEdge(t)},isInlineEmpty:function(){return this.inline.isEmpty()},hasInlineSpaceFor:function(t){return this.inline.hasSpaceFor(t)},hasLineBreak:function(){return this.inline.hasLineBreak()},setLineBreak:function(t){this.inline.setLineBreak(t)},setBreakAfter:function(t){this.inline.setBreakAfter(t)},addInlineElement:function(t,e){this.inline.addElement(t,e)},getInlineLastText:function(){return this.inline.getLastText()},getInlineTexts:function(){return this.inline.getTexts()},getInlineElements:function(){return this.inline.getElements()},getInlineCurMeasure:function(){return this.inline.getCurMeasure()},getInlineRestMeasure:function(){return this.inline.getRestMeasure()},getInlineMaxMeasure:function(){return this.inline.getMaxMeasure()},getInlineMaxExtent:function(){return this.inline.getMaxExtent()},getInlineMaxFontSize:function(){return this.inline.getMaxFontSize()},getInlineCharCount:function(){return this.inline.getCharCount()},justify:function(t){return this.inline.justify(t)}},t}(),Ze=function(){function t(t,e){e=e||{},this.curExtent=0,this.maxExtent=t,this.pushedElements=[],this.elements=[],this.pulledElements=[],this.breakAfter=!1,this.contextEdge=e.contextEdge||{before:0,after:0},this.isFirstBlock="undefined"==typeof e.isFirstBlock?!0:e.isFirstBlock}return t.prototype={hasSpaceFor:function(t,e){e=e||!1;var n=this.getCancelSize(e);return this.getRestExtent()>=t-n},hasBreakAfter:function(){return this.breakAfter},addElement:function(t,e){this.curExtent+=e,t.breakAfter&&(this.breakAfter=!0),t.pushed?this.pushedElements.push(t):t.pulled?this.pulledElements.unshift(t):this.elements.push(t)},getCancelEdge:function(t){return{before:this.isFirstBlock?0:this.contextEdge.before,after:t?0:this.contextEdge.after}},getCancelSize:function(t){var e=this.getCancelEdge(t);return e.before+e.after},getCurExtent:function(){return this.curExtent},getRestExtent:function(){return this.maxExtent-this.curExtent},getMaxExtent:function(){return this.maxExtent},getElements:function(){return this.pulledElements.concat(this.elements).concat(this.pushedElements)}},t}(),Qe=function(){function t(t){this.charCount=0,this.curMeasure=0,this.maxMeasure=t,this.maxExtent=0,this.maxFontSize=0,this.elements=[],this.texts=[],this.lineBreak=!1,this.breakAfter=!1}return t.prototype={isEmpty:function(){return!this.lineBreak&&!this.breakAfter&&0===this.elements.length},hasSpaceFor:function(t){return this.getRestMeasure()>=t},hasLineBreak:function(){return this.lineBreak},setLineBreak:function(t){this.lineBreak=t},hasBreakAfter:function(){return this.breakAfter},setBreakAfter:function(t){this.breakAfter=t},addElement:function(t,e){this.elements.push(t),I.isText(t)?(this.texts.push(t),t.getCharCount&&(this.charCount+=t.getCharCount())):t instanceof me&&(this.maxExtent=t.maxExtent?Math.max(this.maxExtent,t.maxExtent):Math.max(this.maxExtent,t.getLayoutExtent()),t.maxFontSize&&(this.maxFontSize=Math.max(this.maxFontSize,t.maxFontSize)),t.breakAfter&&(this.breakAfter=!0)),this.curMeasure+=e},getLastText:function(){return u.last(this.texts)},getTexts:function(){return this.texts},getElements:function(){return this.elements},getCurMeasure:function(){return this.curMeasure},getRestMeasure:function(){return this.maxMeasure-this.curMeasure},getMaxMeasure:function(){return this.maxMeasure},getMaxExtent:function(){return this.maxExtent},getMaxFontSize:function(){return this.maxFontSize},getCharCount:function(){return this.charCount},getLastChar:function(){return u.last(this.texts)},justify:function(t){for(var e,n=this.texts.length-1,i=n;i>=0&&(e=this.texts[i],t&&t.isHeadNg&&t.isHeadNg()||e.isTailNg&&e.isTailNg())&&!(t&&e&&t.pos-e.pos>1);)t=e,i--;return i>=0&&n>i?(this.elements=u.filter(this.elements,function(e){return e.pos?e.pos<t.pos:!0}),t):null}},t}(),Je=function(){function t(t,e){this.style=t,this.stream=e,this._parentLayout=null,this._childLayout=null,this._cachedElements=[],this._terminate=!1}return t.prototype.yield=function(t){var e=t?this._createChildContext(t):this._createStartContext();return this._yield(e)},t.prototype._yield=function(){throw"LayoutGenerator::_yield must be implemented in child class"},t.prototype.setTerminate=function(t){this._terminate=t},t.prototype.setChildLayout=function(t){this._childLayout=t,t._parentLayout=this},t.prototype.hasNext=function(){return this._terminate?!1:this.hasCache()?!0:this.hasChildLayout()?!0:this.stream?this.stream.hasNext():!1},t.prototype.hasChildLayout=function(){return this._childLayout&&this._childLayout.hasNext()?!0:!1},t.prototype.hasCache=function(){return this._cachedElements.length>0},t.prototype.yieldChildLayout=function(t){var e=this._childLayout.yield(t);return e},t.prototype.peekLastCache=function(){return u.last(this._cachedElements)},t.prototype.pushCache=function(t){var e=t.cacheCount||0;return e>0&&e>=i.maxRollbackCount?(console.error("[%s] too many retry:%o",this.style.getMarkupName(),this.style),void this.setTerminate(!0)):(t.cacheCount=e+1,void this._cachedElements.push(t))},t.prototype.popCache=function(){var t=this._cachedElements.pop();return t},t.prototype.clearCache=function(){this._cachedElements=[]},t.prototype.addText=function(t){this.stream&&this.stream.addText(t)},t.prototype._onAddElement=function(){},t.prototype._onCreate=function(){},t.prototype._onComplete=function(){},t.prototype._createStartContext=function(){return new Xe(new Ze(this.style.contentExtent,{isFirstBlock:!0,contextEdge:this.style.getBlockContextEdge()}),new Qe(this.style.contentMeasure))},t.prototype._createChildContext=function(t){var e=this.style.getBlockContextEdge(),n=this.stream?this.stream.isHead():!0,i=t.getBlockRestExtent()-e.before-e.after;return new Xe(new Ze(i,{isFirstBlock:n,contextEdge:e}),new Qe(this.style.contentMeasure))},t.prototype._createStream=function(t){switch(t.getMarkupName()){case"ruby":return new Be(t.markup);default:return new Ee(t.getContent())}},t.prototype._createFloatGenerator=function(t,e){{var n=this,i=this.style,r=[e];this.stream.iterWhile(function(e){if(I.isWhiteSpace(e))return!0;if(!I.isTag(e))return!1;var s=new $e(e,i,{cursorContext:t});if(!s.isFloated())return i.removeChild(s),!1;var a=n._createStream(s),o=n._createChildBlockGenerator(s,a,t);return r.push(o),!0})}return new ln(this.style,this.stream,r)},t.prototype._createChildBlockGenerator=function(t,e,n){if(t.hasFlipFlow())return new an(t,e,n);if(t.isPasted())return new sn(t,t.createBlock({content:t.getContent()}));switch(t.display){case"list-item":return new dn(t,e);case"table":return new pn(t,e);case"table-header-group":case"table-row-group":case"table-footer-group":return new mn(t,e);case"table-row":return new yn(t,e);case"table-cell":return new xn(t,e)}switch(t.getMarkupName()){case"img":return new sn(t,t.createImage());case"hr":return new sn(t,t.createBlock());case"first-line":return new rn(t,e);case"details":case"blockquote":case"figure":case"fieldset":return new cn(t,e);case"section":case"article":case"nav":case"aside":return new fn(t,e);case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return new bn(t,e);case"ul":case"ol":return new gn(t,e);default:return new Ye(t,e)}},t.prototype._createChildInlineGenerator=function(t,e){if(t.isInlineBlock())return new en(t,e);if(t.isPasted())return new sn(t,t.createLine({content:t.getContent()}));switch(t.getMarkupName()){case"img":return new sn(t,t.createImage());case"a":return new nn(t,e);default:return new tn(t,e)}},t}(),Ye=function(){function t(t,e){Je.call(this,t,e),"body"===this.style.getParentMarkupName()&&(this.rootBlockId=Se.genRootBlockId()),this.blockId=Se.genBlockId()}return o.extend(t,Je),t.prototype._yield=function(t){if(!t.hasBlockSpaceFor(1,!this.hasNext()))return null;if(this.style.isBreakBefore())return this.style.clearBreakBefore(),null;for(;;){if(!this.hasNext())return this._createOutput(t,!0);var e=this._getNext(t),n=!this.hasNext();if(null===e)return this._createOutput(t,n);var i=e.getLayoutExtent(this.style.flow);if(!t.hasBlockSpaceFor(i,n))return this.pushCache(e),this._createOutput(t,!1);if(this._addElement(t,e,i),!t.hasBlockSpaceFor(1,n)||t.hasBreakAfter())return this._createOutput(t,n)}},t.prototype.popCache=function(t){var e=Je.prototype.popCache.call(this);return e&&"inline"===e.display&&e.getLayoutMeasure(this.style.flow)<this.style.contentMeasure&&!e.br&&this._childLayout&&this._childLayout.rollback?(this._childLayout.rollback(e),this.yieldChildLayout(t)):e},t.prototype._getNext=function(t){if(this.hasCache()){var e=this.popCache(t);return e}if(this.hasChildLayout()){var n=this.yieldChildLayout(t);return n}var i=this.stream?this.stream.get():null;if(null===i)return null;if(I.isWhiteSpace(i))return this.stream.skipUntil(I.isWhiteSpace),this._getNext(t);if(I.isText(i))return this.stream.prev(),this.setChildLayout(new tn(this.style,this.stream)),this.yieldChildLayout(t);var r=new $e(i,this.style,{cursorContext:t});if(r.isDisabled())return this.style.removeChild(r),this._getNext(t);if(r.isPageBreak())return t.setBreakAfter(!0),null;var s=this._createStream(r);if(r.isFloated()){var a=this._createChildBlockGenerator(r,s,t);return this.setChildLayout(this._createFloatGenerator(t,a)),this.yieldChildLayout(t)}if(r.isInlineBlock()||r.isInline()){var o=this._createChildInlineGenerator(r,s,t);return this.setChildLayout(new tn(this.style,this.stream,o)),this.yieldChildLayout(t)}return this.setChildLayout(this._createChildBlockGenerator(r,s,t)),this.yieldChildLayout(t)},t.prototype._addElement=function(t,e,n){null!==e&&(t.addBlockElement(e,n),this._onAddElement(e))},t.prototype._createOutput=function(t,e){var n=t.getBlockCurExtent(),i=t.getBlockElements();if(0===n||0===i.length)return null;var r={blockId:this.blockId,extent:n,elements:i,breakAfter:t.hasBreakAfter(),cancelEdge:t.getBlockCancelEdge(e)};"undefined"!=typeof this.rootBlockId&&(r.rootBlockId=this.rootBlockId);var s=this.style.createBlock(r);return this._onCreate(t,s),this.hasNext()||this._onComplete(t,s),s},t}(),tn=function(){function t(t,e,n){Je.call(this,t,e),n&&this.setChildLayout(n)}o.extend(t,Je);var e=function(t){var e=t.elements[0];return e instanceof me?e.style.getMarkupPos():e.pos};return t.prototype._yield=function(t){if(!t.hasInlineSpaceFor(1))return null;for(;this.hasNext();){var e=this._getNext(t);if(null===e)break;var n=this._getMeasure(e);if(0===n)break;if(!t.hasInlineSpaceFor(n)){this.pushCache(e);break}if(this._addElement(t,e,n),!t.hasInlineSpaceFor(1))break}return this._createOutput(t)},t.prototype.rollback=function(t){if(null!==this.stream){var n=t instanceof me?e(t):t.pos;this.stream.setPos(n);var i=this.popCache();i&&this._childLayout&&this._childLayout.rollback&&this._childLayout.rollback(i)}},t.prototype._createChildContext=function(t){return new Xe(t.block,new Qe(t.getInlineRestMeasure()))},t.prototype._createOutput=function(t){if(t.isInlineEmpty())return null;!t.hasLineBreak()&&i.justify&&this._justifyLine(t);var e=this.style.createLine({lineBreak:t.hasLineBreak(),breakAfter:t.hasBreakAfter(),measure:t.getInlineCurMeasure(),elements:t.getInlineElements(),texts:t.getInlineTexts(),charCount:t.getInlineCharCount(),maxExtent:t.getInlineMaxExtent(),maxFontSize:t.getInlineMaxFontSize()});return this._parentLayout&&this._parentLayout.stream&&(e.pos=Math.max(0,this._parentLayout.stream.getPos()-1)),this._onCreate(t,e),this.hasNext()||this._onComplete(t,e),e},t.prototype._justifyLine=function(t){var e=this.stream?this.stream.peek():null;e&&I.isTag(e)&&"br"===e.getName()&&this.stream.get();var n=this.peekLastCache()||this.stream.peek(),i=t.justify(n);i&&(this.stream.setPos(i.pos),this.clearCache())},t.prototype._getNext=function(t){if(this.hasCache()){var e=this.popCache(t);return e}if(this.hasChildLayout())return this.yieldChildLayout();var n=this.stream.get();if(null===n)return null;if(I.isText(n))return"horizontal"===this.style.getTextCombine()?this._getTcy(t,n):I.isWhiteSpace(n)?this._getWhiteSpace(t,n):this._getText(t,n);var i=this.style;if(n instanceof B&&(i=new $e(n,this.style,{cursorContext:t})),i.isDisabled())return this._getNext(t);var r=this._createStream(i);if(i.isBlock()||i.isFloated()){var s=this._createChildBlockGenerator(i,r,t);return i.isFloated()&&(s=this._createFloatGenerator(t,s)),this._breakInline(s),t.setLineBreak(!0),null}if(i.isInlineBlock())return new en(i,r).yield(t);switch(i.getMarkupName()){case"img":return i.createImage();case"br":return t.setLineBreak(!0),null;case"page-break":case"pbr":case"end-page":return t.setBreakAfter(!0),null;default:var a=this._createChildInlineGenerator(i,r,t);return this.setChildLayout(a),this.yieldChildLayout(t)}},t.prototype._breakInline=function(e){this.setTerminate(!0),null!==this._parentLayout&&(this._parentLayout instanceof t?this._parentLayout._breakInline(e):this._parentLayout.setChildLayout(e))},t.prototype._getTcy=function(t){this.setTerminate(!0);var e=new L(this.style.getMarkupContent());return this._getText(t,e)},t.prototype._getWhiteSpace=function(t,e){return this.style.isPre()?I.isNewLine(e)?null:this._getText(t,e):(this.stream.skipUntil(I.isNewLine),I.isNewLine(e)?this._getNext(t):this._getText(t,e))},t.prototype._getText=function(t,e){if(e.hasMetrics()||this._setTextMetrics(t,e),e instanceof R)return e;switch(e._type){case"char":case"tcy":return e;case"word":return this._getWord(t,e)}},t.prototype._setTextMetrics=function(t,e){e instanceof z&&i.kerning&&this._setCharKerning(t,e),e.setMetrics(this.style.flow,this.style.font)},t.prototype._setCharKerning=function(t,e){var n=this.stream.peek(),i=t.getInlineLastText(),r=n&&I.isText(n)?n:null;
Le.set(e,i,r)},t.prototype._getWord=function(t,e){var n=t.getInlineRestMeasure(),i=e.getAdvance(this.style.flow,this.style.letterSpacing||0);if(n>=i)return e.setDivided(!1),e;if(i<=t.getInlineMaxMeasure()&&!this.style.isWordBreakAll())return this.stream.prev(),null;var r=e.cutMeasure(this.style.getFontSize(),n);return r.setMetrics(this.style.flow,this.style.font),e.setMetrics(this.style.flow,this.style.font),""!==e.data&&e.bodySize>0&&this.stream.prev(),r.bodySize=Math.min(n,r.bodySize),r},t.prototype._getMeasure=function(t){return t instanceof me?t.getLayoutMeasure(this.style.flow):t.getAdvance?t.getAdvance(this.style.flow,this.style.letterSpacing||0):0},t.prototype._addElement=function(t,e,n){t.addInlineElement(e,n),this._onAddElement(e)},t}(),en=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t.prototype._onCreate=function(t,e){var n=u.maxobj(e.elements,function(t){return t.getContentMeasure()});return n&&e.size.setMeasure(this.style.flow,n.getContentMeasure()),e},t.prototype._createChildContext=function(t){return new Xe(new Ze(t.getBlockRestExtent()-this.style.getEdgeExtent()),new Qe(t.getInlineRestMeasure()-this.style.getEdgeMeasure()))},t}(),nn=function(){function t(t,n){tn.call(this,t,n),e(t)}var e=function(t){var e=t.getMarkupAttr("name");e&&Se.addAnchor(e)};return o.extend(t,tn),t.prototype._onComplete=function(){e(this.style)},t}(),rn=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t.prototype._onAddElement=function(t){"inline"===t.display&&"undefined"==typeof this._first&&(this._first=!0,this.style=this.style.parent,this._childLayout&&(this._childLayout.style=this.style))},t}(),sn=function(){function t(t,e){Je.call(this,t,null),this.output=e}return o.extend(t,Je),t.prototype.hasNext=function(){return!this._terminate},t.prototype.yield=function(){return this._terminate?null:(this._terminate=!0,this.output)},t}(),an=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t.prototype.yield=function(t){return this.style.updateContextSize(t.getBlockRestExtent(),t.getInlineMaxMeasure()),Ye.prototype.yield.call(this)},t}(),on=function(){function t(t,e){this.elements=t||[],this.floatDirection=e||Fe.get("start")}return t.prototype={add:function(t){this.elements.unshift(t)},isFloatStart:function(){return this.floatDirection.isStart()},isFloatEnd:function(){return this.floatDirection.isEnd()},getElements:function(){return this.isFloatStart()?this.elements:u.reverse(this.elements)},getMeasure:function(t){return u.fold(this.elements,0,function(e,n){return e+n.getLayoutMeasure(t)})},getExtent:function(t){return u.fold(this.elements,0,function(e,n){return Math.max(e,n.getLayoutExtent(t))})}},t}(),un=function(){function t(t,e,i){var r=n(t,Fe.get("start"),e),s=n(t,Fe.get("end"),i);this.stack=r.concat(s).sort(function(e,n){return e.getExtent(t)-n.getExtent(t)});var a=u.maxobj(this.stack,function(e){return e.getExtent(t)});this.extent=a?a.getExtent(t):0}var e=function(t,e,n){var i=n.pop()||null;if(null===i)return null;for(var r=i.getLayoutExtent(t),s=new on([i],e);;){var a=n.pop();if(!(a&&a.getLayoutExtent(t)<=r)){n.push(a);break}s.add(a)}return s},n=function(t,n,i){var r,s=[];do r=e(t,n,i),r&&s.push(r);while(null!==r);return s};return t.prototype={isEmpty:function(){return 0===this.stack.length},getExtent:function(){return this.extent},pop:function(){return this.stack.pop()||null}},t}(),ln=function(){function t(t,e,n){Ye.call(this,t,e),this.generators=n,this.setChildLayout(new Ye(t.clone({"float":"start"}),e))}return o.extend(t,Je),t.prototype.hasNext=function(){return this._hasNextFloat()?!0:this._termFloat&&!this.hasCache()?!1:Je.prototype.hasNext.call(this)},t.prototype._hasNextFloat=function(){return u.exists(this.generators,function(t){return t.hasNext()})},t.prototype._yield=function(t){var e=this._yieldFloatStack(t);if(this._hasNextFloat()&&e.isEmpty())return null;var n=t.getInlineRestMeasure(),i=e.getExtent(),r=n;return this._yieldFloat(t,e,r,n,i)},t.prototype._yieldFloat=function(t,e,n,i,r){if(0>=i)return null;var s=this.style.flow;if(e.isEmpty())return this._yieldFloatSpace(t,i,r);var a=e.pop(),o=i-a.getMeasure(s),u=this._yieldFloat(t,e,n,o,a.getExtent(s)),l=this._wrapFloat(a,u,i),h=r-a.getExtent(s);if(!(this._hasNextFloat()||n!==i&&this.stream.hasNext()))return this._termFloat=!0,this._parentLayout._cachedElements=this._childLayout._cachedElements,this._parentLayout._childLayout=this._childLayout._childLayout||null,this._parentLayout._childLayout&&(this._parentLayout._childLayout.style.forceUpdateContextSize(n,h),this._parentLayout._childLayout._parentLayout=this._parentLayout),l;if(0>=h)return l;var c=this._yieldFloatSpace(t,i,h);return this._wrapBlock(l,c)},t.prototype._sortFloatRest=function(t,e){var n=t.getElements();return t.isFloatStart()?n.concat(e):[e].concat(n)},t.prototype._wrapBlock=function(t,e){var n=this.style.flow,i=t.getLayoutMeasure(n),r=t.getLayoutExtent(n)+(e?e.getLayoutExtent(n):0),s=e?[t,e]:[t],a=u.exists(s,function(t){return t&&t.breakAfter?!0:!1});return this.style.createChild("div",{"float":"start",measure:i}).createBlock({elements:s,breakAfter:a,extent:r})},t.prototype._wrapFloat=function(t,e,n){var i=this.style.flow,r=t.getExtent(i),s=this._sortFloatRest(t,e),a=u.exists(s,function(t){return t&&t.breakAfter?!0:!1});return this.style.createChild("div",{"float":"start",measure:n}).createBlock({elements:s,breakAfter:a,extent:r})},t.prototype._yieldFloatSpace=function(t,e,n){return this._childLayout.style.forceUpdateContextSize(e,n),this.yieldChildLayout()},t.prototype._yieldFloatStack=function(t){var e=[],n=[];return u.iter(this.generators,function(i){var r=i.yield(t);r&&(i.style.isFloatStart()?e.push(r):i.style.isFloatEnd()&&n.push(r))}),new un(this.style.flow,e,n)},t}(),hn=function(){function t(t,e){Je.call(this,t,null),this.generators=e}return o.extend(t,Je),t.prototype._yield=function(t){if(this.hasCache())return this.popCache();var e=this._yieldParallelBlocks(t);if(null===e)return null;var n=this._wrapBlocks(e),i=n.getLayoutExtent(this.style.flow);return t.hasBlockSpaceFor(i)?(t.addBlockElement(n,i),n):(this.pushCache(n),null)},t.prototype.hasNext=function(){return this._terminate?!1:this.hasCache()?!0:u.exists(this.generators,function(t){return t.hasNext()})},t.prototype._yieldParallelBlocks=function(t){var e=u.map(this.generators,function(e){return e.yield(t)});return u.forall(e,function(t){return null===t})?null:e},t.prototype._findMaxBlock=function(t){var e=this.style.flow;return u.maxobj(t,function(t){return t?t.getLayoutExtent(e):0})},t.prototype._alignContentExtent=function(t,e){var n=this.style.flow,i=this.generators;return u.mapi(t,function(t,r){return null===r?i[t].style.createBlock({elements:[],extent:e}):r.resizeExtent(n,e)})},t.prototype._wrapBlocks=function(t){var e=this.style.flow,n=this._findMaxBlock(t),i=this._alignContentExtent(t,n.getContentExtent(e));return this.style.createBlock({elements:i,extent:n.getLayoutExtent(e)})},t}(),cn=function(){function t(t,e){Ye.call(this,t,e),this.style.startOutlineContext()}return o.extend(t,Ye),t.prototype._onComplete=function(){this.style.endOutlineContext()},t}(),fn=function(){function t(t,e){Ye.call(this,t,e),this.style.startSectionContext()}return o.extend(t,Ye),t.prototype._onComplete=function(){this.style.endSectionContext()},t}(),gn=function(){function t(t,e){Ye.call(this,t,e),this.style.setListItemCount(this.stream.getTokenCount())}return o.extend(t,Ye),t}(),dn=function(){function t(t,e){hn.call(this,t,[this._createListMarkGenerator(t),this._createListBodyGenerator(t,e)])}return o.extend(t,hn),t.prototype._createListMarkGenerator=function(t){var e=t.getListMarkerSize(),n=t.getChildIndex(),i=t.getListMarkerHtml(n+1),r=e.getMeasure(t.flow),s=t.createChild("li-marker",{"float":"start",measure:r},{"class":"nehan-li-marker"});return new Ye(s,new Ee(i))},t.prototype._createListBodyGenerator=function(t,e){var n=t.getListMarkerSize(),i=t.contentMeasure-n.getMeasure(t.flow),r=t.createChild("li-body",{"float":"start",measure:i},{"class":"nehan-li-body"});return new Ye(r,e)},t}(),pn=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t}(),mn=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t}(),yn=function(){function t(t,e){var n=this._getGenerators(t,e);hn.call(this,t,n)}return o.extend(t,hn),t.prototype._getGenerators=function(t,e){var n=this._getChildTags(e),i=this._getChildStyles(t,n);return u.map(i,function(t){return new xn(t,new Ee(t.getMarkupContent()))})},t.prototype._getChildStyles=function(t,e){var n=t.contentMeasure,i=t.getTablePartition(),r=i?i.getSizes({partitionCount:e.length,measure:t.contentMeasure}):[];return u.mapi(e,function(i,s){var a=new $e(s,t),o=a.staticMeasure,u=o&&n>=o?o:Math.floor(n/(e.length-i));return r.length>0&&(u=r[i]),n-=u,a.clone({"float":"start",measure:u})})},t.prototype._getChildTags=function(t){return t.getAllIf(function(t){return t instanceof B&&("td"===t.getName()||"th"===t.getName())})},t}(),xn=function(){function t(t,e){cn.call(this,t,e)}return o.extend(t,cn),t}(),bn=function(){function t(t,e){Ye.call(this,t,e)}return o.extend(t,Ye),t.prototype._getHeaderRank=function(){return this.style.getMarkupName().match(/h([1-6])/)?parseInt(RegExp.$1,10):0},t.prototype._onComplete=function(t,e){var n=this.style.startHeaderContext({type:this.style.getMarkupName(),rank:this._getHeaderRank(),title:this.style.getMarkupContent()});e.id=d.addNehanHeaderPrefix(n)},t}(),vn=function(){function t(t){var e=new B("<body>",t);cn.call(this,new $e(e,null),new Ee(t))}return o.extend(t,cn),t.prototype._onCreate=function(t,e){e.seekPos=this.stream.getSeekPos(),e.charPos=Se.getCharPos(),e.percent=this.stream.getSeekPercent(),e.pageNo=Se.getPageNo(),Se.stepCharPos(e.charCount||0),Se.stepPageNo(),Se.getPageNo()>=i.maxPageCount&&this.setTerminate(!0)},t}(),_n=function(){function t(t){this.stream=new Ae(t),this.generator=this._createGenerator()}return t.prototype={"yield":function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},setTerminate:function(t){this.generator.setTerminate(t)},addText:function(t){this.generator.addText(t)},_createGenerator:function(){for(;this.stream.hasNext();){var t=this.stream.get();switch(t.getName()){case"head":this._parseDocumentHeader(new Te(t.getContent()));break;case"body":return this._createBodyGenerator(t.getContent())}}return this._createBodyGenerator(this.stream.getSrc())},_createBodyGenerator:function(t){return new vn(t)},_parseDocumentHeader:function(t){for(var e=new we;t.hasNext();){var n=t.get();switch(n.getName()){case"title":e.setTitle(n.getContent());break;case"meta":e.addMeta(n);break;case"link":e.addLink(n);break;case"style":e.addStyle(n);break;case"script":e.addScript(n)}}Se.setDocumentHeader(e)}},t}(),kn=function(){function t(t){this.stream=new Ne(t),this.generator=this._createGenerator()}return t.prototype={"yield":function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},setTerminate:function(t){this.generator.setTerminate(t)},addText:function(t){this.generator.addText(t)},_createGenerator:function(){for(;this.stream.hasNext();){var t=this.stream.get();switch(t.getName()){case"!doctype":Se.setDocumentType("html");break;case"html":return this._createHtmlGenerator(t)}}var e=new B("<html>",this.stream.getSrc());return this._createHtmlGenerator(e)},_createHtmlGenerator:function(t){return new _n(t.getContent())}},t}(),Cn=function(){function t(t){this.direction=t}return t.prototype={evaluate:function(t){return this._getEvaluator(t)._evaluate(t)},_getEvaluator:function(t){var e=t.style.isTextVertical();return"vert"!==this.direction||e?"hori"===this.direction&&e?new wn:this:new Sn},_createElement:function(t,e){e=e||{};var n=e.css||{},i=e.attrs?e.attrs instanceof T?e.attrs.attrs:e.attrs:{},r=e.attrs?e.attrs.dataset:{},s=document.createElement(t);return e.id&&(s.id=e.id),e.className&&(s.className=e.className),e.content&&(s.innerHTML=e.content),"undefined"!=typeof e.rootBlockId&&(r.rootBlockId=e.rootBlockId),"undefined"!=typeof e.blockId&&(r.blockId=e.blockId),l.iter(n,function(t,e){s.style[h.camelize(t)]=e}),l.iter(i,function(t,e){if("style"!==t&&"class"!==t)try{s[t]=e}catch(n){console.error("try to set %o to %s but failed.",e,t)}}),y.copy(s.dataset,r),e.oncreate&&e.oncreate(s,e.styleContext||null),s},_createClearFix:function(t){var e=document.createElement("div");return e.style.clear=t||"both",e},_evaluate:function(t,e){e=e||{};var n=this,i=u.filter(t.elements,function(t){return null!==t}),r=this._evalTreeRoot(t,e);return r.innerHTML?r:u.fold(i,r,function(e,i){return r.appendChild(n._evalTreeChild(t,i)),i.withBr&&r.appendChild(document.createElement("br")),i.withClearFix&&r.appendChild(n._createClearFix()),r})},_evalTreeRoot:function(t,e){return e=e||{},this._createElement(e.name||"div",{id:t.getId(),className:t.getClassName(),attrs:t.getAttrs(),oncreate:t.getOnCreate(),content:e.content||t.getContent(),rootBlockId:t.rootBlockId,blockId:t.blockId,css:e.css||t.getCssRoot(),styleContext:t.style})},_evalTreeChild:function(t,e){switch(t.display){case"inline":return e instanceof me?this._evalInlineChildElement(t,e):this._evalInlineChildText(t,e);default:return this._evalBlockChildElement(t,e)}},_evalBlockChildElement:function(t,e){switch(e.style.getMarkupName()){case"img":return this._evalImage(e);case"a":return this._evalLink(e);default:return this.evaluate(e)}},_evalInlineChildElement:function(t,e){switch(e.style.getMarkupName()){case"img":return this._evalInlineImage(t,e);case"a":return this._evalLink(e);default:return this._evalInlineChildTree(e)}},_evalInlineChildText:function(t,e){return t.style.isTextEmphaEnable()&&I.isEmphaTargetable(e)?this._evalEmpha(t,e):this._evalTextElement(t,e)},_evalImage:function(t){return this._evalTreeRoot(t,{name:"img"})},_evalInlineImage:function(t,e){return this._evalImage(e)},_evalLink:function(t){var e=new fe(t.style.getMarkupAttr("href")),n=e.getAnchorName();if(n){var i=Se.getAnchorPageNo(n);t.classes.push("nehan-anchor-link"),t.style.markup.setAttr("data-page",i)}return this._evaluate(t,{name:"a"})},_evalTextElement:function(t,e){switch(e._type){case"word":return this._evalWord(t,e);case"char":return this._evalChar(t,e);case"tcy":return this._evalTcy(t,e);case"ruby":return this._evalRuby(t,e);default:throw console.error("invalid text element:%o",e),"invalid text element"}}},t}(),wn=function(){function t(){Cn.call(this,"vert")}return o.extend(t,Cn),t.prototype._evalInlineChildTree=function(t){return this._evaluate(t)},t.prototype._evalInlineImage=function(t,e){return e.withBr=!0,this._evalTreeRoot(e,{name:"img",css:e.getCssInline()})},t.prototype._evalRuby=function(t,e){var n=this._createElement("div",{className:"nehan-ruby-body",styleContext:t.style});return n.appendChild(this._evalRb(t,e)),n.appendChild(this._evalRt(t,e)),n},t.prototype._evalRb=function(t,e){var n=new $e(new B("<rb>"),t.style),i=n.createLine({elements:e.getRbs()});return this._evaluate(i,{css:e.getCssVertRb(t)})},t.prototype._evalRt=function(t,e){var n=new tn(new $e(e.rt,t.style),new Ee(e.getRtString()),null).yield();return y.copy(n.css,e.getCssVertRt(t)),this._evaluate(n)},t.prototype._evalWord=function(t,e){return Nehan.Env.isTransformEnable?Nehan.Env.client.isTrident()?this._evalWordTransformTrident(t,e):this._evalWordTransform(t,e):Nehan.Env.client.isIE()?this._evalWordIE(t,e):""},t.prototype._evalWordTransform=function(t,e){var n=this._createElement("div",{css:e.getCssVertTrans(t),styleContext:t.style}),i=this._createElement("div",{content:e.data,className:"nehan-rotate-90",css:e.getCssVertTransBody(t),styleContext:t.style});return n.appendChild(i),n},t.prototype._evalWordTransformTrident=function(t,e){var n=this._createElement("div",{css:e.getCssVertTrans(t),styleContext:t.style}),i=this._createElement("div",{content:e.data,css:e.getCssVertTransBodyTrident(t),styleContext:t.style});return n.appendChild(i),n},t.prototype._evalWordIE=function(t,e){return this._createElement("div",{content:e.data,className:"nehan-vert-ie",css:e.getCssVertTransIE(t),styleContext:t.style})},t.prototype._evalRotateChar=function(t,e){return Nehan.Env.isTransformEnable?this._evalRotateCharTransform(t,e):Nehan.Env.client.isIE()?this._evalRotateCharIE(t,e):this._evalCharWithBr(t,e)},t.prototype._evalRotateCharTransform=function(t,e){return this._createElement("div",{content:e.getData(),className:"nehan-rotate-90",styleContext:t.style})},t.prototype._evalRotateCharIE=function(t,e){return this._createElement("div",{content:e.getData(),className:"nehan-vert-ie",css:e.getCssVertRotateCharIE(t),styleContext:t.style})},t.prototype._evalTcy=function(t,e){return this._createElement("div",{content:e.data,className:"nehan-tcy",styleContext:t.style})},t.prototype._evalChar=function(t,e){return e.isImgChar()?e.isVertGlyphEnable()?this._evalVerticalGlyph(t,e):this._evalImgChar(t,e):e.isHalfSpaceChar(e)?this._evalHalfSpaceChar(t,e):e.isRotateChar()?this._evalRotateChar(t,e):e.isSmallKana()?this._evalSmallKana(t,e):e.isPaddingEnable()?this._evalPaddingChar(t,e):t.letterSpacing?this._evalCharLetterSpacing(t,e):this._evalCharWithBr(t,e)},t.prototype._evalCharWithBr=function(t,e){return e.withBr=!0,document.createTextNode(p.unescape(e.getData()))},t.prototype._evalCharLetterSpacing=function(t,e){return this._createElement("div",{content:e.getData(),css:e.getCssVertLetterSpacing(t),styleContext:t.style})},t.prototype._evalEmpha=function(t,e){var n=this._createElement("span",{content:e.getData(),className:"nehan-empha-src",css:e.getCssVertEmphaTarget(t),styleContext:t.style}),i=this._createElement("span",{content:t.style.textEmpha.getText(),className:"nehan-empha-text",css:e.getCssVertEmphaText(t),styleContext:t.style}),r=this._createElement("div",{className:"nehan-empha-wrap",css:t.style.textEmpha.getCssVertEmphaWrap(t,e),styleContext:t.style});return r.appendChild(n),r.appendChild(i),r},t.prototype._evalPaddingChar=function(t,e){return this._createElement("div",{content:e.getData(),css:e.getCssPadding(t),styleContext:t.style})},t.prototype._evalImgChar=function(t,e){var n=t.color||new V(r.fontColor),i=n.getRgb(),s=O.getColor(i).toUpperCase();return this._createElement("img",{className:"nehan-img-char",attrs:{src:e.getImgSrc(s)},css:e.getCssVertImgChar(t),styleContext:t.style})},t.prototype._evalVerticalGlyph=function(t,e){return this._createElement("div",{content:e.getData(),className:"nehan-vert-glyph",css:e.getCssVertGlyph(t),styleContext:t.style})},t.prototype._evalSmallKana=function(t,e){var n=t.style.textEmpha&&t.style.textEmpha.isEnable()?"span":"div";return this._createElement(n,{content:e.getData(),css:e.getCssVertSmallKana(),styleContext:t.style})},t.prototype._evalHalfSpaceChar=function(t,e){return this._createElement("div",{content:"&nbsp;",css:e.getCssVertHalfSpaceChar(t),styleContext:t.style})},t}(),Sn=function(){function t(){Cn.call(this,"hori")}return o.extend(t,Cn),t.prototype._evalInlineChildTree=function(t){return this._evaluate(t,{name:"span"})},t.prototype._evalRuby=function(t,e){var n=this._createElement("span",{className:"nehan-ruby-body",css:e.getCssHoriRuby(t),styleContext:t.style});return n.appendChild(this._evalRt(t,e)),n.appendChild(this._evalRb(t,e)),n},t.prototype._evalRb=function(t,e){var n=new $e(new B("<rb>"),t.style),i=n.createLine({elements:e.getRbs()});return this._evaluate(i,{css:e.getCssHoriRb(t)})},t.prototype._evalRt=function(t,e){return this._createElement("div",{content:e.getRtString(),className:"nehan-rt",css:e.getCssHoriRt(t),styleContext:t.style})},t.prototype._evalWord=function(t,e){return document.createTextNode(e.data)},t.prototype._evalTcy=function(t,e){return document.createTextNode(p.unescape(e.data))},t.prototype._evalChar=function(t,e){return e.isHalfSpaceChar()?document.createTextNode(e.data):e.isCharRef()?document.createTextNode(p.unescape(e.data)):e.isKerningChar()?this._evalKerningChar(t,e):document.createTextNode(e.data)},t.prototype._evalEmpha=function(t,e){var n=this._createElement("div",{content:e.data,className:"nehan-empha-src",css:e.getCssHoriEmphaTarget(t),styleContext:t.style}),i=this._createElement("div",{content:t.style.textEmpha.getText(),className:"nehan-empha-text",css:e.getCssHoriEmphaText(t),styleContext:t.style}),r=this._createElement("span",{css:t.style.textEmpha.getCssHoriEmphaWrap(t,e),styleContext:t.style});return r.appendChild(i),r.appendChild(n),r},t.prototype._evalKerningChar=function(t,e){var n=e.getCssPadding(t);return e.isKakkoStart()?(n["margin-left"]="-0.5em",this._createElement("span",{content:e.data,className:"nehan-char-kakko-start",css:n,styleContext:t.style})):e.isKakkoEnd()?(n["margin-right"]="-0.5em",this._createElement("span",{content:e.data,className:"nehan-char-kakko-end",css:n,styleContext:t.style})):e.isKutenTouten()?(n["margin-right"]="-0.5em",this._createElement("span",{content:e.data,className:"nehan-char-kuto",css:n,styleContext:t.style})):document.createTextNode(e.data)},t.prototype._evalPaddingChar=function(t,e){return this._createElement("span",{content:e.data,css:e.getCssPadding(t),styleContext:t.style})},t}();return y.copy(i,n.config||{}),y.copy2(r,n.display||{}),M.setValues(Nehan.globalStyle||{}),M.setValues(n.style||{}),u.iter(Nehan.__single_tag_names__,s.addSingleTagByName),u.iter(Nehan.__single_tag_rexes__,s.addSingleTagByRex),e.prototype={createPageStream:function(t){return new Pe(t)},createOutlineElement:function(t){return this.documentContext.createBodyOutlineElement(t)},getAnchorPageNo:function(t){return this.documentContext.getAnchorPageNo(t)},addSingleTagByName:function(t){this.lexingRule.addSingleTagByName(t)},addSingleTagByRex:function(){this.lexingRule.addSingleTagRex(name)},setStyle:function(t,e){return this.selectors.setValue(t,e),this},setStyles:function(t){return this.selectors.setValues(t),this}},new e},Nehan.PagedElement=function(){function t(t){this.pageNo=0,this.element=document.createElement("div"),this.engine=Nehan.createEngine(t),this._pageStream=null}return t.prototype={isLastPage:function(){return this.getPageNo()+1>=this.getPageCount()},getEngine:function(){return this.engine},getElement:function(){return this.element},getContent:function(){return this._pageStream?this._pageStream.text:""},getPageCount:function(){return this._pageStream?this._pageStream.getPageCount():0},getPage:function(t){return this._pageStream?this._pageStream.getPage(t):null},getPagedElement:function(t){var e=this.getPage(t);return e?e.element:null},getPageNo:function(){return this.pageNo},setNextPage:function(){return this.pageNo+1<this.getPageCount()?this.setPage(this.pageNo+1):null},setPrevPage:function(){return this.pageNo>0?this.setPage(this.pageNo-1):null},setStyle:function(t,e){return this.engine.setStyle(t,e),this},setStyles:function(t){return this.engine.setStyles(t),this},setContent:function(t,e){return this._pageStream=this.engine.createPageStream(t),this._asyncGet(e||{}),this},addContent:function(t,e){this._pageStream.addText(t),this._asyncGet(e||{})},setPage:function(t){var e=this.getPage(t);if(null===e||null===e.element)return null;for(this.pageNo=t;this.element.firstChild;)this.element.removeChild(this.element.firstChild);return this.element.appendChild(e.element),e},_asyncGet:function(t){this._pageStream.asyncGet({onProgress:function(e,n){0===n.pageNo&&this.setPage(n.pageNo),t.onProgress&&t.onProgress(n)}.bind(this),onComplete:function(e,n){t.onComplete&&t.onComplete(n)}.bind(this)})}},t}(),Nehan.createPagedElement=function(t){return new Nehan.PagedElement(t||{})};